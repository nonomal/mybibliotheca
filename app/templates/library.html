{% extends "base.html" %}
{% block title %}My Library - MyBibliotheca{% endblock %}
{% block content %}
<style>
  :root {
    --primary-brown: #8B4513;
    --light-brown: #D2B48C;
    --cream: #F5F5DC;
    --warm-white: #FEFEFE;
    --gold: #DAA520;
    --shadow: rgba(0,0,0,0.1);
    --hover-shadow: rgba(0,0,0,0.2);
    --text-color: #333;
    --header-text: white;
    --card-bg: white;
    --card-text: #333;
  }

  /* Dark mode overrides */
  [data-theme="dark"] {
    --primary-brown: #6b5b73;
    --light-brown: #8a7ca8;
    --cream: #2d2d2d;
    --warm-white: #1e1e1e;
    --gold: #f0c674;
    --shadow: rgba(0,0,0,0.3);
    --hover-shadow: rgba(0,0,0,0.5);
    --text-color: #e0e0e0;
    --header-text: #f0c674;
    --card-bg: #2d2d2d;
    --card-text: #e0e0e0;
  }

  [data-theme="dark"] .library-stats {
    background: var(--card-bg) !important;
    border-color: #404040 !important;
    color: var(--card-text) !important;
  }

  [data-theme="dark"] .filter-section {
    background: var(--card-bg) !important;
    border-color: #404040 !important;
    color: var(--card-text) !important;
  }

  [data-theme="dark"] .card {
    background-color: var(--card-bg) !important;
    border-color: #404040 !important;
    color: var(--card-text) !important;
  }

  [data-theme="dark"] .card-body {
    background-color: var(--card-bg) !important;
    color: var(--card-text) !important;
  }

  [data-theme="dark"] .text-muted {
    color: #b0b0b0 !important;
  }

  [data-theme="dark"] .filter-title {
    color: var(--gold) !important;
  }

  [data-theme="dark"] .btn-outline-primary {
    border-color: #6ea8fe;
    color: #6ea8fe;
  }

  [data-theme="dark"] .btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
  }

  [data-theme="dark"] h5 {
    color: var(--card-text) !important;
  }

  .library-stats {
    background: var(--warm-white);
    border: 2px solid var(--light-brown);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 8px var(--shadow);
  }

  .filter-section {
    background: var(--warm-white);
    border: 2px solid var(--light-brown);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 6px 20px var(--shadow);
    position: relative;
  }

  .filter-section::before {
    content: 'üîç';
    position: absolute;
    top: -10px;
    left: 20px;
    background: var(--primary-brown);
    color: white;
    padding: 8px 12px;
    border-radius: 50%;
    font-size: clamp(1rem, 2vw, 1.2rem);
  }

  .filter-title {
    color: var(--primary-brown);
    font-weight: 600;
    margin-bottom: 1rem;
    padding-left: 40px;
    font-size: clamp(1rem, 2vw, 1.25rem);
  }

  .bookshelf-container {
    background: linear-gradient(145deg, #f0e6d2 0%, #e6dcc6 100%);
    border-radius: 20px;
    padding: clamp(1rem, 3vw, 2rem);
    box-shadow: inset 0 4px 8px rgba(0,0,0,0.1);
    position: relative;
  }

  .bookshelf-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('{{ url_for('serve_static', filename='wood-pattern.png') }}');
    opacity: 0.2;
    border-radius: 20px;
  }

  .filter-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: end;
  }

  .books-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: clamp(1rem, 2vw, 1.5rem);
    position: relative;
    z-index: 1;
  }

  .book-card {
    background: var(--warm-white);
    border-radius: 12px;
    box-shadow: 0 4px 12px var(--shadow);
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
    cursor: pointer;
    border: 2px solid transparent;
  }

  .book-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px var(--hover-shadow);
    border-color: var(--light-brown);
  }

  .book-card.selected {
    border-color: var(--primary-brown);
    box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.3);
    transform: translateY(-2px);
  }

  .book-selection {
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 10;
    background: white;
    border-radius: 4px;
    padding: 2px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .book-checkbox {
    width: 16px;
    height: 16px;
    accent-color: var(--primary-brown);
  }

  .book-cover-wrapper {
    text-align: center;
    padding: 1rem 1rem 0;
    background: linear-gradient(to bottom, #faf9f7, #f5f3f0);
  }

  .book-cover-shelf {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    transition: transform 0.2s ease;
  }

  .book-card:hover .book-cover-shelf {
    transform: scale(1.02);
  }

  .book-info {
    padding: 1rem;
    text-align: center;
  }

  .book-title {
    font-weight: 600;
    color: var(--primary-brown);
    font-size: 0.9rem;
    line-height: 1.2;
    margin-bottom: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .book-author {
    color: #666;
    font-size: 0.8rem;
    margin-bottom: 0.75rem;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .book-meta {
    margin-bottom: 0.75rem;
  }

  .category-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    justify-content: center;
  }

  .category-badge {
    background: var(--cream);
    color: var(--primary-brown);
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 8px;
    border: 1px solid var(--light-brown);
  }

  .rating-display {
    font-size: 0.8rem;
    color: var(--gold);
  }

  .book-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    justify-content: center;
  }

  .status-badge {
    font-size: 0.7rem;
    padding: 4px 8px;
  }

  .selection-toolbar {
    background: var(--primary-brown);
    color: white;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 8px var(--shadow);
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #666;
  }

  .empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    color: var(--primary-brown);
    margin-bottom: 1rem;
  }

  .btn-success {
    background-color: var(--gold);
    border-color: var(--gold);
    color: #333;
  }

  .btn-success:hover {
    background-color: #b8941a;
    border-color: #b8941a;
  }

  @media (max-width: 768px) {
    .books-grid {
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }

    .book-cover-shelf {
      height: 160px;
    }

    .filter-form {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">
            <i class="bi bi-book me-2"></i>My Library
        </h1>
    </div>

<!-- Library Stats -->
<div class="library-stats">
  <div class="row text-center">
    <div class="col-md-3 col-6">
      <div class="h4 mb-0 text-primary">{{ books|selectattr('finish_date')|list|length }}</div>
      <small class="text-muted">Books Read</small>
    </div>
    <div class="col-md-3 col-6">
      <div class="h4 mb-0 text-warning">{{ books|rejectattr('finish_date')|rejectattr('want_to_read')|rejectattr('library_only')|list|length }}</div>
      <small class="text-muted">Currently Reading</small>
    </div>
    <div class="col-md-3 col-6">
      <div class="h4 mb-0 text-info">{{ books|selectattr('want_to_read')|list|length }}</div>
      <small class="text-muted">Plan to Read</small>
    </div>
    <div class="col-md-3 col-6">
      <div class="h4 mb-0 text-secondary">{{ books|length }}</div>
      <small class="text-muted">Total Books</small>
    </div>
  </div>
</div>

<!-- Advanced Filter Section -->
<div class="filter-section">
  <h5 class="filter-title">Find Your Books</h5>
  <form method="GET" class="filter-form">
    <div>
      <label for="search" class="form-label fw-semibold">Search</label>
      <input type="text" class="form-control" id="search" name="search" 
             value="{{ current_search }}" placeholder="Title, author, description...">
    </div>
    <div>
      <label for="category" class="form-label fw-semibold">{{ get_genre_term() }}</label>
      <select class="form-select" id="category" name="category">
        <option value="">{{ get_genre_term_plural() }}</option>
        {% for category in categories %}
          <option value="{{ category }}" {% if category == current_category %}selected{% endif %}>
            {{ category }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="publisher" class="form-label fw-semibold">Publisher</label>
      <select class="form-select" id="publisher" name="publisher">
        <option value="">Publishers</option>
        {% for publisher in publishers %}
          <option value="{{ publisher }}" {% if publisher == current_publisher %}selected{% endif %}>
            {{ publisher }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="language" class="form-label fw-semibold">Language</label>
      <select class="form-select" id="language" name="language">
        <option value="">Languages</option>
        {% for language in languages %}
          <option value="{{ language }}" {% if language == current_language %}selected{% endif %}>
            {{ language }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div>
      <button type="submit" class="btn btn-primary w-100">üîç Filter</button>
    </div>
  </form>
  <div class="mt-3 text-center">
    <a href="{{ url_for('main.library') }}" class="btn btn-secondary btn-sm me-3">Clear All Filters</a>
    <span class="text-muted fw-semibold">Showing {{ books|length }} book(s)</span>
  </div>
</div>

<!-- Add Book Section -->
<div class="filter-section text-center">
  <a href="{{ url_for('main.add_book') }}" class="btn btn-success btn-lg">
    <i class="bi bi-plus-circle"></i> Add Books to Your Library
  </a>
</div>

<!-- Books Grid -->
<div class="bookshelf-container">
  {% if books %}
    <!-- Selection toolbar -->
    <div id="selection-toolbar" class="selection-toolbar" style="display: none;">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <span id="selection-count">0</span> book(s) selected
        </div>
        <div>
          <button type="button" class="btn btn-outline-light btn-sm" onclick="selectAll(); console.log('Select All clicked');">Select All</button>
          <button type="button" class="btn btn-outline-light btn-sm" onclick="clearSelection(); console.log('Clear Selection clicked');">Clear Selection</button>
          <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelected(); console.log('Delete Selected clicked');">Delete Selected</button>
        </div>
      </div>
    </div>

    <form id="bulk-delete-form" method="POST" action="{{ url_for('main.bulk_delete_books') }}" style="display: none;">
      <!-- CSRF token will be automatically added by JavaScript -->
      <!-- Hidden inputs for selected books will be added here -->
    </form>

    <div class="books-grid">
      {% for book in books %}
        <div class="book-card" data-book-id="{{ book.uid }}">
          <!-- Selection checkbox -->
          <div class="book-selection">
            <input type="checkbox" class="book-checkbox" value="{{ book.uid }}">
          </div>

          <div class="book-cover-wrapper" onclick="openBook('{{ book.uid }}')">
            <img 
              src="{{ book.cover_url or url_for('serve_static', filename='bookshelf.png') }}"
              class="book-cover-shelf"
              alt="{{ book.title }} cover"
              onerror="this.onerror=null;this.src='{{ url_for('serve_static', filename='bookshelf.png') }}'">
          </div>

          <div class="book-info" onclick="openBook('{{ book.uid }}')">
            <div class="book-title">
              {{ book.title }}
            </div>

            <div class="book-author">{{ book.author }}</div>

            <div class="book-meta">
              {% if book.average_rating %}
                <div class="rating-display mb-2">
                  {% for i in range(5) %}
                    {% if i < book.average_rating %}‚≠ê{% else %}‚òÜ{% endif %}
                  {% endfor %}
                  {{ "%.1f"|format(book.average_rating) }}
                  {% if book.rating_count %}<small>({{ book.rating_count }})</small>{% endif %}
                </div>
              {% endif %}
            </div>

            <div class="book-badges">
              {% if book.want_to_read %}
                <span class="badge bg-info status-badge">Plan to Read</span>
              {% elif not book.finish_date and not book.library_only %}
                <span class="badge bg-warning status-badge">Reading</span>
              {% elif book.finish_date %}
                <span class="badge bg-success status-badge">Finished</span>
              {% elif book.library_only %}
                <span class="badge bg-secondary status-badge">Library</span>
              {% endif %}
              
              <!-- Location Debug Badge -->
              {% if book.locations %}
                <span class="badge bg-primary" title="Locations: {{ book.locations|join(', ') }}">üìç {{ book.locations|length }}</span>
              {% else %}
                <span class="badge bg-warning" title="No location assigned">üìç None</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="books-grid">
      <div class="empty-state">
        <div class="empty-state-icon">üìö</div>
        <h3>No books found</h3>
        <p>Try adjusting your filters or <a href="{{ url_for('main.add_book') }}">add some books</a> to your library!</p>
      </div>
    </div>
  {% endif %}
</div>

<script>
// Book selection and navigation functionality
function openBook(uid) {
    window.location.href = `{{ url_for('main.view_book_enhanced', uid='PLACEHOLDER') }}`.replace('PLACEHOLDER', uid);
}

function updateSelection() {
    console.log('updateSelection called'); // Debug
    const checkboxes = document.querySelectorAll('.book-checkbox');
    const selectedBoxes = document.querySelectorAll('.book-checkbox:checked');
    const toolbar = document.getElementById('selection-toolbar');
    const count = document.getElementById('selection-count');
    
    console.log(`Found ${checkboxes.length} checkboxes, ${selectedBoxes.length} selected`); // Debug
    
    // Update visual state of book cards
    checkboxes.forEach(checkbox => {
        const bookCard = checkbox.closest('.book-card');
        if (checkbox.checked) {
            bookCard.classList.add('selected');
        } else {
            bookCard.classList.remove('selected');
        }
    });
    
    if (count) {
        count.textContent = selectedBoxes.length;
    }
    
    if (toolbar) {
        if (selectedBoxes.length > 0) {
            toolbar.style.display = 'block';
        } else {
            toolbar.style.display = 'none';
        }
    }
}

function selectAll() {
    console.log('selectAll called'); // Debug
    const checkboxes = document.querySelectorAll('.book-checkbox');
    console.log(`Selecting ${checkboxes.length} checkboxes`); // Debug
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelection();
}

function clearSelection() {
    console.log('clearSelection called'); // Debug
    const checkboxes = document.querySelectorAll('.book-checkbox');
    console.log(`Clearing ${checkboxes.length} checkboxes`); // Debug
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelection();
}

function deleteSelected() {
    console.log('deleteSelected called'); // Debug
    const selectedBoxes = document.querySelectorAll('.book-checkbox:checked');
    console.log(`Found ${selectedBoxes.length} selected books`); // Debug
    
    if (selectedBoxes.length === 0) {
        console.log('No books selected, showing alert'); // Debug
        alert('No books selected for deletion.');
        return;
    }
    
    console.log('Showing confirmation dialog'); // Debug
    if (!confirm(`Are you sure you want to delete ${selectedBoxes.length} selected book(s)? This action cannot be undone.`)) {
        console.log('User cancelled deletion'); // Debug
        return;
    }
    
    // Create form and submit
    const form = document.getElementById('bulk-delete-form');
    if (!form) {
        console.error('bulk-delete-form not found'); // Debug
        alert('Error: Could not find delete form. Please refresh the page.');
        return;
    }
    
    console.log('Form found, preparing submission'); // Debug
    
    // Clear form and let automatic CSRF protection handle the token
    form.innerHTML = '';
    
    selectedBoxes.forEach((checkbox, index) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_books';
        input.value = checkbox.value;
        form.appendChild(input);
        console.log(`Added book ${index + 1}: ${checkbox.value} to form`); // Debug
    });
    
    // Ensure CSRF token is added (the global script will handle this automatically)
    addCSRFToForm(form);
    console.log('CSRF token automatically added'); // Debug
    
    console.log('Submitting form with method:', form.method, 'to action:', form.action); // Debug
    console.log('Form elements:', form.elements.length); // Debug
    form.submit();
}

// Add some interactive enhancements
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded'); // Debug
    
    // Test if elements exist
    const toolbar = document.getElementById('selection-toolbar');
    const form = document.getElementById('bulk-delete-form');
    const checkboxes = document.querySelectorAll('.book-checkbox');
    
    console.log(`Found toolbar: ${!!toolbar}, form: ${!!form}, checkboxes: ${checkboxes.length}`); // Debug
    
    // Add event listeners to checkboxes using event delegation
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('book-checkbox')) {
            console.log('Checkbox changed:', e.target.value, e.target.checked); // Debug
            updateSelection();
        }
    });
    
    // Prevent checkbox area from triggering card click
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('book-checkbox') || e.target.closest('.book-selection')) {
            e.stopPropagation();
            console.log('Stopped propagation for checkbox click'); // Debug
        }
    });
    
    // Auto-submit form on filter change
    const filterSelects = document.querySelectorAll('#category, #publisher, #language');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });

    // Add loading animation to book cards
    const bookCards = document.querySelectorAll('.book-card');
    bookCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.style.animation = 'fadeInUp 0.6s ease forwards';
    });
    
    // Initialize selection state
    updateSelection();
});

// CSS Animation
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .book-card {
        opacity: 0;
    }
`;
document.head.appendChild(style);
</script>

</div>

<!-- Debug Panel (Admin Only) -->
{% include 'components/debug_panel.html' %}

{% endblock %}
