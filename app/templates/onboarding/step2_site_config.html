{% extends "onboarding/base_onboarding.html" %}

{% block title %}Site Configuration - MyBibliotheca{% endblock %}

{% block progress_width %}40%{% endblock %}

{% block step_info %}Step 2 of 5: Site Configuration & Backups{% endblock %}

{% block content %}
<div class="form-header">
    <div class="icon-circle" style="background: linear-gradient(135deg, #17a2b8, #138496);">
        <i class="bi bi-gear-fill"></i>
    </div>
    <h2>Customize Your Installation</h2>
    <p>These settings (and backup settings below) can be changed later in the admin panel.</p>
</div>

<form method="POST" class="needs-validation" novalidate>
    <!-- CSRF Token -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <!-- Site Name Field -->
    <div class="form-group">
        <label for="site_name" class="form-label">
            <i class="bi bi-house-heart"></i>
            Site Name
        </label>
        <input type="text" 
               id="site_name" 
               name="site_name" 
               class="form-control" 
               value="{{ current_config.get('site_name', 'MyBibliotheca') }}" 
               placeholder="e.g., John's Library, Family Library"
               tabindex="1">
        <div class="form-text">This will appear as the title of your library</div>
    </div>
    
    <!-- Timezone Field -->
    <div class="form-group">
        <label for="timezone" class="form-label">
            <i class="bi bi-clock me-1"></i>
            Timezone
        </label>
        <select id="timezone" 
                name="timezone" 
                class="form-control" 
                tabindex="2">
            {% for tz in timezones %}
                <option value="{{ tz }}" 
                        {% if tz == current_config.get('timezone', 'UTC') %}selected{% endif %}>
                    {{ tz }}
                </option>
            {% endfor %}
        </select>
        <div class="form-text">Used for displaying dates and reading logs</div>
    </div>

    <!-- Reading Log Defaults (Optional) -->
    <hr class="my-4">
    <h4 class="mb-3"><i class="bi bi-journal-plus me-2"></i>Reading Log Defaults <span class="badge bg-secondary" style="font-size: 0.7rem;">Optional</span></h4>
    <p class="text-muted">You can set default values that will pre-fill new reading log entries and be used during reading history import when a row is missing both values. You can change these anytime in Admin settings.</p>
    <div class="row g-3 align-items-end mb-2">
        <div class="col-md-3 col-6">
            <label for="ob_default_pages" class="form-label">Default Pages per Log</label>
            <input type="number" id="ob_default_pages" name="default_pages_per_log" class="form-control" min="0" step="1" value="{{ current_config.get('default_pages_per_log') or '' }}" placeholder="e.g., 10">
        </div>
        <div class="col-md-3 col-6">
            <label for="ob_default_minutes" class="form-label">Default Minutes per Log</label>
            <input type="number" id="ob_default_minutes" name="default_minutes_per_log" class="form-control" min="0" step="1" value="{{ current_config.get('default_minutes_per_log') or '' }}" placeholder="e.g., 20">
        </div>
    </div>
    
    <!-- Default Location Field -->
    <div class="form-group">
        <label for="location" class="form-label">
            <i class="bi bi-geo-alt me-1"></i>
            Default Location 
            <span class="badge bg-secondary ms-1" style="font-size: 0.7rem;">Optional</span>
        </label>
        <input type="text" 
               id="location" 
               name="location" 
               class="form-control" 
               value="{{ current_config.get('location', '') }}" 
               placeholder="e.g., Home Library, Study Room"
               tabindex="3">
        <div class="form-text">Set a default location for your books and reading logs</div>
    </div>
    
    <!-- Location Auto-assign Checkbox -->
    <div class="form-group">
        <div class="form-check">
            <input type="checkbox" 
                   class="form-check-input" 
                   id="location_set_as_default" 
                   name="location_set_as_default"
                   {% if current_config.get('location_set_as_default') %}checked{% endif %}
                   tabindex="4">
            <label class="form-check-label" for="location_set_as_default">
                Auto-assign location to new books
            </label>
            <div class="form-text">
                If enabled, this location will be automatically assigned to all books added to your library
            </div>
        </div>
    </div>

    <!-- Terminology Preference Field -->
    <div class="form-group">
        <label for="terminology_preference" class="form-label">
            <i class="bi bi-tags me-1"></i>
            Book Classification Terminology
        </label>
        <select id="terminology_preference" 
                name="terminology_preference" 
                class="form-control" 
                tabindex="5">
            <option value="genre" 
                    {% if current_config.get('terminology_preference', 'genre') == 'genre' %}selected{% endif %}>
                Genres (e.g., "Science Fiction", "Romance", "Mystery")
            </option>
            <option value="category" 
                    {% if current_config.get('terminology_preference') == 'category' %}selected{% endif %}>
                Categories (e.g., "Fiction", "Non-Fiction", "Reference")
            </option>
        </select>
        <div class="form-text">This affects how book classifications are displayed throughout the interface</div>
    </div>
    
    <!-- Automatic Backup Settings (moved from former Step 3) -->
    <hr class="my-4">
    <h4 class="mb-3"><i class="bi bi-shield-lock me-2"></i>Automatic Backups</h4>
    <p class="text-muted">Protect your data with daily automatic backups (recommended). You can change these settings later in Admin &gt; Backups.</p>
    <div class="row g-3 align-items-end mb-2">
        <div class="col-md-2 col-6">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="ob_backup_enabled" name="backup_enabled" {% if current_config.get('backup_settings', {}).get('enabled', True) %}checked{% endif %}>
                <label class="form-check-label" for="ob_backup_enabled">Enable daily backups</label>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <label for="ob_retention" class="form-label">Retention (days)</label>
            <input type="number" id="ob_retention" name="backup_retention_days" class="form-control" value="{{ current_config.get('backup_settings', {}).get('retention_days', 14) }}" min="1">
        </div>
        <div class="col-md-2 col-6">
            <label for="ob_hour" class="form-label">Hour</label>
            <input type="number" id="ob_hour" name="backup_scheduled_hour" class="form-control" value="{{ current_config.get('backup_settings', {}).get('scheduled_hour', 2) }}" min="0" max="23">
        </div>
        <div class="col-md-2 col-6">
            <label for="ob_minute" class="form-label">Minute</label>
            <input type="number" id="ob_minute" name="backup_scheduled_minute" class="form-control" value="{{ current_config.get('backup_settings', {}).get('scheduled_minute', 30) }}" min="0" max="59">
        </div>
        <div class="col-md-2 col-6">
            <label for="ob_frequency" class="form-label">Frequency</label>
            <select id="ob_frequency" name="backup_frequency" class="form-select">
                <option value="daily" {% if current_config.get('backup_settings', {}).get('frequency', 'daily') == 'daily' %}selected{% endif %}>Daily</option>
                <option value="weekly" {% if current_config.get('backup_settings', {}).get('frequency') == 'weekly' %}selected{% endif %}>Weekly (future)</option>
            </select>
        </div>
    </div>
    <small class="text-muted d-block mb-4">A backup runs after imports and at the scheduled time. Backups include database, covers, uploads, and settings.</small>

    <!-- Metadata Provider Preferences -->
    <hr class="my-4">
    <h4 class="mb-3"><i class="bi bi-diagram-2 me-2"></i>Metadata Providers</h4>
    <p class="text-muted">Choose which external provider supplies metadata during imports. You can fine-tune every field later in Settings &gt; Server &gt; Metadata.</p>
    <div class="row g-3 align-items-end mb-2">
        <div class="col-md-4 col-12">
            <label class="form-label" for="ob_book_metadata_mode">Books Metadata</label>
            <select id="ob_book_metadata_mode" name="book_metadata_mode" class="form-select">
                <option value="both" selected>Google + OpenLibrary</option>
                <option value="google">Google Only</option>
                <option value="openlibrary">OpenLibrary Only</option>
            </select>
            <div class="form-text">When both are used, Google is the initial default (can be changed later).</div>
        </div>
        <div class="col-md-4 col-12">
            <label class="form-label" for="ob_people_metadata_mode">People Metadata</label>
            <select id="ob_people_metadata_mode" name="people_metadata_mode" class="form-select">
                <option value="openlibrary" selected>OpenLibrary</option>
                <option value="none">None (skip automatic enrichment)</option>
            </select>
            <div class="form-text">People enrichment currently relies on OpenLibrary.</div>
        </div>
    </div>
    <small class="text-muted d-block mb-4">Field-level priorities (e.g., description vs cover) can be customized later.</small>

    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
        <a href="{{ url_for('onboarding.step', step_num=1) }}" 
           class="btn btn-outline-secondary" 
           tabindex="7">
            <i class="bi bi-arrow-left me-2"></i>Back
        </a>
        <button type="submit" 
                class="btn btn-primary" 
                tabindex="6">
            Continue to Data Options<i class="bi bi-arrow-right ms-2"></i>
        </button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
// Auto-detect timezone
document.addEventListener('DOMContentLoaded', function() {
    const timezoneSelect = document.getElementById('timezone');
    const currentValue = timezoneSelect.value;
    
    // Only auto-detect if no timezone is already set
    if (!currentValue || currentValue === 'UTC') {
        try {
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (userTimezone) {
                const option = timezoneSelect.querySelector(`option[value="${userTimezone}"]`);
                if (option) {
                    option.selected = true;
                }
            }
        } catch (e) {
            console.log('Timezone auto-detection not supported');
        }
    }
});
</script>
{% endblock %}
