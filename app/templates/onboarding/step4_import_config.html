{% extends "onboarding/base_onboarding.html" %}

{% block title %}Import Configuration - MyBibliotheca{% endblock %}

{% block progress_width %}80%{% endblock %}

{% block step_info %}Step 4 of 5: Import Configuration{% endblock %}

{% block extra_styles %}
.mapping-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border-left: 4px solid #667eea;
}

.mapping-row {
    display: grid;
    grid-template-columns: 2fr 3fr;
    gap: 1rem;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e9ecef;
}

@media (max-width: 768px) {
    .mapping-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
        text-align: left;
    }
    
    .csv-column {
        margin-bottom: 0.5rem;
    }
}

.mapping-row:last-child {
    border-bottom: none;
}

.csv-column {
    font-weight: 600;
    color: #333;
    font-family: monospace;
    background: #e9ecef;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.field-mapping-select {
    padding: 0.5rem;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 0.9rem;
    background: white;
}

.field-mapping-select:focus {
    border-color: #667eea;
    outline: none;
}

.custom-metadata-options {
    margin-top: 0.5rem;
    padding: 0.75rem;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    display: none;
}

.custom-metadata-options label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #856404;
    margin-bottom: 0.25rem;
    display: block;
}

.custom-metadata-options select {
    width: 100%;
    padding: 0.375rem;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    font-size: 0.85rem;
}

.preview-section {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    font-size: 0.85rem;
}

.preview-table th,
.preview-table td {
    padding: 0.5rem;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.preview-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.import-options {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.form-check {
    margin-bottom: 0.75rem;
}

.form-check-input {
    margin-right: 0.5rem;
}

.custom-fields-summary {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    display: none;
}

.custom-fields-summary h6 {
    color: #166534;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.custom-fields-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.custom-fields-list li {
    padding: 0.25rem 0;
    color: #166534;
    font-size: 0.9rem;
}
{% endblock %}

{% block content %}
<div class="form-header">
    <div class="icon-circle" style="background: linear-gradient(135deg, #28a745, #20c997);">
        <i class="bi bi-file-earmark-spreadsheet"></i>
    </div>
    <h2>Configure Import Settings</h2>
    <p>Map your CSV columns to book fields and configure import options.</p>
</div>

<form method="POST" id="importConfigForm">
    <!-- CSRF Token -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <!-- Column Mapping -->
    {% if csv_headers %}
    <div class="mapping-section">
        <div style="font-weight: 600; margin-bottom: 1rem; color: #333; display: flex; align-items: center; gap: 0.5rem;">
            <i class="bi bi-arrow-left-right"></i>
                Column Mapping
                <div data-bs-toggle="tooltip" title="Map each CSV column to a field or skip it."></div>
        </div>
        <p style="color: #666; margin-bottom: 1.5rem; font-size: 0.9rem;">
            Map the columns from your CSV file to the corresponding book fields in MyBibliotheca.
        </p>
        
        {% for header in csv_headers %}
        <div class="mapping-row">
            <div class="csv-column">{{ header }}</div>
            <div>
                    <select name="field_mapping_{{ loop.index0 }}" class="field-mapping-select" data-column="{{ header }}" data-bs-toggle="tooltip" title="Select the matching field for '{{ header }}' or choose to skip.">
                    <option value="">-- Skip this column --</option>
                    <option value="title" {% if 'title' in header.lower() %}selected{% endif %}>Title</option>
                    <option value="author" {% if 'author' in header.lower() %}selected{% endif %}>Author</option>
                    <option value="isbn" {% if 'isbn' in header.lower() %}selected{% endif %}>ISBN</option>
                    <option value="description" {% if 'description' in header.lower() or 'summary' in header.lower() %}selected{% endif %}>Description</option>
                    <option value="genre" {% if 'genre' in header.lower() or 'category' in header.lower() %}selected{% endif %}>Genre</option>
                    <option value="publisher" {% if 'publisher' in header.lower() %}selected{% endif %}>Publisher</option>
                    <option value="published_date" {% if 'date' in header.lower() or 'year' in header.lower() %}selected{% endif %}>Published Date</option>
                    <option value="page_count" {% if 'page' in header.lower() %}selected{% endif %}>Page Count</option>
                    <option value="language" {% if 'language' in header.lower() or 'lang' in header.lower() %}selected{% endif %}>Language</option>
                    <option value="rating" {% if 'rating' in header.lower() or 'stars' in header.lower() %}selected{% endif %}>Rating</option>
                    <option value="read_status" {% if 'status' in header.lower() or 'read' in header.lower() %}selected{% endif %}>Read Status</option>
                    <option value="date_read" {% if 'read' in header.lower() and 'date' in header.lower() %}selected{% endif %}>Date Read</option>
                    <option value="custom_metadata:{{ header }}">Custom Field: {{ header }}</option>
                </select>
                
                <!-- Custom metadata options -->
                <div class="custom-metadata-options">
                    <label for="custom_type_{{ loop.index0 }}">Field Type:</label>
                    <select name="custom_type_{{ loop.index0 }}" id="custom_type_{{ loop.index0 }}">
                        <option value="text">Text</option>
                        <option value="number">Number</option>
                        <option value="date">Date</option>
                        <option value="boolean">Yes/No</option>
                    </select>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Data Preview -->
    {% if sample_data %}
    <div class="preview-section">
        <h5 style="color: #166534; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="bi bi-eye"></i>
            Data Preview (First 3 rows)
        </h5>
        <div style="overflow-x: auto;">
            <table class="preview-table">
                <thead>
                    <tr>
                        {% for header in csv_headers %}
                        <th>{{ header }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in sample_data[:3] %}
                    <tr>
                        {% for cell in row %}
                        <td>{{ cell[:50] + ('...' if cell|length > 50 else '') if cell else '' }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- Import Options -->
    <div class="import-options">
        <h5 style="color: #1565c0; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;" data-bs-toggle="tooltip" title="Control how duplicate detection and metadata enrichment behave during import.">
            <i class="bi bi-gear"></i>
            Import Options
        </h5>
        
        <div class="form-check">
            <input type="checkbox" class="form-check-input" id="skip_duplicates" name="skip_duplicates" checked>
            <label class="form-check-label" for="skip_duplicates">
                Skip duplicate books (based on title and author)
            </label>
        </div>
        
        <div class="form-check">
            <input type="checkbox" class="form-check-input" id="create_collections" name="create_collections">
            <label class="form-check-label" for="create_collections">
                Create collections from category/shelf data
            </label>
        </div>
    </div>
    
    <!-- Custom Fields Summary -->
    <div class="custom-fields-summary">
        <h6>
            <i class="bi bi-magic"></i>
            Custom Fields Will Be Created
        </h6>
        <p style="margin-bottom: 1rem; color: #166534;">
            The following custom metadata fields will be automatically created for your library:
        </p>
        <ul class="custom-fields-list"></ul>
    </div>
    
    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
        <a href="{{ url_for('onboarding.step', step_num=3) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <button type="submit" class="btn btn-primary">
            Continue <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
function updateCustomFieldsSummary() {
    const customFields = [];
    const fieldSelects = document.querySelectorAll('.field-mapping-select');
    
    fieldSelects.forEach(function(select, index) {
        if (select.value.startsWith('custom_metadata:')) {
            const fieldName = select.value.replace('custom_metadata:', '');
            const typeSelect = document.querySelector(`select[name="custom_type_${index}"]`);
            const fieldType = typeSelect ? typeSelect.value : 'text';
            customFields.push(`${fieldName} (${fieldType})`);
        }
    });
    
    const summary = document.querySelector('.custom-fields-summary');
    const list = document.querySelector('.custom-fields-list');
    
    if (customFields.length > 0) {
        list.innerHTML = customFields.map(field => `<li>• ${field}</li>`).join('');
        summary.style.display = 'block';
    } else {
        summary.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const fieldSelects = document.querySelectorAll('.field-mapping-select');
    
    fieldSelects.forEach(function(select) {
        const customOptions = select.parentNode.querySelector('.custom-metadata-options');
        const typeSelect = select.parentNode.querySelector('select[name^="custom_type_"]');
        
        select.addEventListener('change', function() {
            if (this.value.startsWith('custom_metadata:')) {
                customOptions.style.display = 'block';
                this.classList.add('custom-selected');
            } else {
                customOptions.style.display = 'none';
                this.classList.remove('custom-selected');
            }
            updateCustomFieldsSummary();
        });
        
        // Add event listener for type changes
        if (typeSelect) {
            typeSelect.addEventListener('change', updateCustomFieldsSummary);
        }
        
        // Check initial state
        if (select.value.startsWith('custom_metadata:')) {
            customOptions.style.display = 'block';
            select.classList.add('custom-selected');
        }
    });
    
    // Initial summary update
    updateCustomFieldsSummary();
});
</script>
{% endblock %}
