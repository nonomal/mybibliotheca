{% extends "base.html" %}
{% block title %}Add Book - Bibliotheca{% endblock %}
{% block content %}
<style>
  /* CSS Variables for consistent theming */
  :root {
    --primary-brown: #8B4513;
    --light-brown: #D2B48C;
    --warm-white: #FFF8DC;
    --cream: #F5F5DC;
    --shadow: rgba(0,0,0,0.1);
  }

  /* Dark mode overrides */
  [data-theme="dark"] {
    --primary-brown: #D2B48C;
    --light-brown: #8B4513;
    --warm-white: #343a40;
    --cream: #495057;
    --shadow: rgba(255,255,255,0.1);
  }

  /* Dark mode specific text improvements */
  [data-theme="dark"] .text-muted {
    color: #adb5bd !important;
  }

  [data-theme="dark"] .small.text-muted {
    color: #ced4da !important;
  }

  [data-theme="dark"] .help-text {
    color: #ced4da !important;
  }

  .help-text {
    color: #6c757d;
  }

  [data-theme="dark"] .lead {
    color: #f8f9fa !important;
  }

  [data-theme="dark"] .tab-content {
    background: var(--bs-dark);
    border-color: #495057;
  }

  [data-theme="dark"] .list-group-item {
    background-color: #495057;
    border-color: #6c757d;
    color: #f8f9fa;
  }

  [data-theme="dark"] .nav-tabs .nav-link {
    color: #f8f9fa;
  }

  [data-theme="dark"] .nav-tabs .nav-link:hover {
    color: var(--primary-brown);
  }

  [data-theme="dark"] .nav-tabs .nav-link.active {
    background-color: var(--primary-brown);
    color: #fff;
  }

  [data-theme="dark"] .form-control {
    background-color: #495057;
    border-color: #6c757d;
    color: #fff;
  }

  [data-theme="dark"] .form-control:focus {
    background-color: #495057;
    border-color: #86b7fe;
    color: #fff;
  }

  [data-theme="dark"] .form-label {
    color: #f8f9fa;
  }

  [data-theme="dark"] .alert-info {
    background-color: #0f3460;
    border-color: #084298;
    color: #b6d7ff;
  }

  [data-theme="dark"] .search-results {
    background: var(--cream);
    border: 1px solid #6c757d;
  }

  .tab-content {
    background: var(--warm-white);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 6px 20px var(--shadow);
    border: 2px solid var(--light-brown);
  }

  .nav-tabs .nav-link {
    color: var(--primary-brown);
    border: 2px solid transparent;
    font-weight: 500;
  }

  .nav-tabs .nav-link.active {
    background-color: var(--primary-brown);
    color: white;
    border-color: var(--primary-brown);
  }

  .nav-tabs .nav-link:hover {
    border-color: var(--light-brown);
    color: var(--primary-brown);
  }

  .btn-primary {
    background-color: var(--primary-brown);
    border-color: var(--primary-brown);
  }

  .btn-primary:hover {
    background-color: #654321;
    border-color: #654321;
  }

  .search-results {
    background: var(--cream);
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
  }

  .list-group-item {
    border: 1px solid var(--light-brown);
    background: var(--warm-white);
  }

  .list-group-item:first-child {
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
  }

  .list-group-item:last-child {
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
  }
</style>

<div class="container mt-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">
            <i class="bi bi-plus-circle me-2"></i>Add Books
        </h1>
        <div>
            <a href="{{ url_for('main.library') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to Library
            </a>
        </div>
    </div>

<!-- Add Book Options Tabs -->
<ul class="nav nav-tabs mb-3" id="addBookTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-add" type="button" role="tab">
      ‚úèÔ∏è Manual Entry
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk-import" type="button" role="tab">
      üìÅ Bulk Import
    </button>
  </li>
</ul>

<div class="tab-content" id="addBookTabsContent">
  <!-- Manual Entry Tab -->
  <div class="tab-pane fade show active" id="manual-add" role="tabpanel">
    <form method="post" action="{{ url_for('main.add_book_manual') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      
      <!-- Basic Book Information -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="manual-isbn" class="form-label">ISBN (Optional)</label>
          <div class="input-group">
            <input type="text" class="form-control" id="manual-isbn" name="isbn" placeholder="Enter ISBN to fetch metadata">
            <button type="button" class="btn btn-outline-secondary" onclick="fetchBookData()">
              <i class="bi bi-search me-1"></i>Fetch
            </button>
          </div>
        </div>
        <div class="col-md-6">
          <label for="manual-title" class="form-label">Title *</label>
          <input type="text" class="form-control" id="manual-title" name="title" required>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label for="manual-author" class="form-label">Author</label>
          <input type="text" class="form-control" id="manual-author" name="author" placeholder="Primary author name">
        </div>
        <div class="col-md-6">
          <label for="manual-subtitle" class="form-label">Subtitle</label>
          <input type="text" class="form-control" id="manual-subtitle" name="subtitle" placeholder="Book subtitle (if any)">
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label for="manual-publisher" class="form-label">Publisher</label>
          <input type="text" class="form-control" id="manual-publisher" name="publisher" placeholder="Publisher name">
        </div>
        <div class="col-md-3">
          <label for="manual-page-count" class="form-label">Page Count</label>
          <input type="number" class="form-control" id="manual-page-count" name="page_count" min="1" placeholder="Number of pages">
        </div>
        <div class="col-md-3">
          <label for="manual-language" class="form-label">Language</label>
          <select class="form-select" id="manual-language" name="language">
            <option value="en" selected>English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="pt">Portuguese</option>
            <option value="ru">Russian</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="zh">Chinese</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label for="manual-cover-url" class="form-label">Cover URL</label>
          <input type="url" class="form-control" id="manual-cover-url" name="cover_url" placeholder="https://...">
        </div>
        <div class="col-md-6">
          <label for="manual-published-date" class="form-label">Published Date</label>
          <input type="date" class="form-control" id="manual-published-date" name="published_date">
        </div>
      </div>

      <!-- Series Information -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="manual-series" class="form-label">Series</label>
          <input type="text" class="form-control" id="manual-series" name="series" placeholder="Series name (if part of a series)">
        </div>
        <div class="col-md-3">
          <label for="manual-series-volume" class="form-label">Volume</label>
          <input type="text" class="form-control" id="manual-series-volume" name="series_volume" placeholder="e.g., Book 1, Vol. 2">
        </div>
        <div class="col-md-3">
          <label for="manual-series-order" class="form-label">Series Order</label>
          <input type="number" class="form-control" id="manual-series-order" name="series_order" min="1" placeholder="1">
        </div>
      </div>

      <!-- Categories/Genres -->
      <div class="row mb-3">
        <div class="col-12">
          <label for="manual-genres" class="form-label">Genres/Categories</label>
          <input type="text" class="form-control" id="manual-genres" name="genres" placeholder="e.g., Science Fiction, Fantasy, Mystery">
          <div class="form-text">Enter one or more genres separated by commas</div>
        </div>
      </div>

      <!-- Reading Status and Ownership -->
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="manual-reading-status" class="form-label">Reading Status</label>
          <select class="form-select" id="manual-reading-status" name="reading_status">
            <option value="plan_to_read" selected>Plan to Read</option>
            <option value="reading">Currently Reading</option>
            <option value="read">Read</option>
            <option value="on_hold">On Hold</option>
            <option value="did_not_finish">Did Not Finish</option>
            <option value="library_only">Library Only (No Reading Intent)</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="manual-ownership-status" class="form-label">Ownership Status</label>
          <select class="form-select" id="manual-ownership-status" name="ownership_status">
            <option value="owned" selected>Owned</option>
            <option value="borrowed">Borrowed</option>
            <option value="loaned">Loaned Out</option>
            <option value="wishlist">Wishlist</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="manual-media-type" class="form-label">Media Type</label>
          <select class="form-select" id="manual-media-type" name="media_type">
            <option value="physical" selected>Physical Book</option>
            <option value="ebook">E-book</option>
            <option value="audiobook">Audiobook</option>
            <option value="kindle">Kindle</option>
          </select>
        </div>
      </div>

      <!-- Location Management -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="manual-location" class="form-label">Location</label>
          <select class="form-select" id="manual-location" name="location_id">
            <option value="">Select a location...</option>
            <!-- Locations will be populated by JavaScript or server-side -->
          </select>
          <div class="form-text">
            <a href="{{ url_for('locations.manage_locations') }}" target="_blank" class="text-decoration-none">
              <i class="bi bi-gear me-1"></i>Manage Locations
            </a>
          </div>
        </div>
        <div class="col-md-6">
          <label for="manual-user-rating" class="form-label">My Rating</label>
          <select class="form-select" id="manual-user-rating" name="user_rating">
            <option value="">No Rating</option>
            <option value="1">‚≠ê 1 Star</option>
            <option value="2">‚≠ê‚≠ê 2 Stars</option>
            <option value="3">‚≠ê‚≠ê‚≠ê 3 Stars</option>
            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 Stars</option>
            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Stars</option>
          </select>
        </div>
      </div>

      <!-- Reading Dates -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="manual-start-date" class="form-label">Start Date</label>
          <input type="date" class="form-control" id="manual-start-date" name="start_date">
        </div>
        <div class="col-md-6">
          <label for="manual-finish-date" class="form-label">Finish Date</label>
          <input type="date" class="form-control" id="manual-finish-date" name="finish_date">
        </div>
      </div>

      <!-- Personal Notes and Tags -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="manual-personal-notes" class="form-label">Personal Notes</label>
          <textarea class="form-control" id="manual-personal-notes" name="personal_notes" rows="3" placeholder="Your personal thoughts about this book..."></textarea>
        </div>
        <div class="col-md-6">
          <label for="manual-user-tags" class="form-label">Personal Tags</label>
          <input type="text" class="form-control" id="manual-user-tags" name="user_tags" placeholder="e.g., favorite, quick-read, beach-book">
          <div class="form-text">Enter tags separated by commas</div>
        </div>
      </div>

      <!-- Book Description -->
      <div class="row mb-3">
        <div class="col-12">
          <label for="manual-description" class="form-label">Description/Summary</label>
          <textarea class="form-control" id="manual-description" name="description" rows="4" placeholder="Book description or summary..."></textarea>
        </div>
      </div>

      <!-- Custom Metadata Section -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="bi bi-tags me-2"></i>Custom Metadata (Optional)
              </h6>
            </div>
            <div class="card-body">
              {% if personal_fields or global_fields %}
                <!-- Personal Custom Fields -->
                {% if personal_fields %}
                  <h6 class="small mb-2">Your Custom Fields:</h6>
                  <div class="row">
                    {% for field in personal_fields %}
                      <div class="col-md-6 mb-3">
                        <label for="custom_field_{{ field.name }}" class="form-label">
                          {{ field.display_name }}
                          {% if field.description %}
                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="{{ field.description }}"></i>
                          {% endif %}
                        </label>
                        {% if field.field_type.value == 'select' %}
                          <select class="form-select" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                            <option value="">Select...</option>
                            {% for option in field.options %}
                              <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                          </select>
                        {% elif field.field_type.value == 'boolean' %}
                          <select class="form-select" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                            <option value="">Select...</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                          </select>
                        {% elif field.field_type.value == 'number' %}
                          <input type="number" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}" step="any">
                        {% elif field.field_type.value == 'date' %}
                          <input type="date" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                        {% elif field.field_type.value == 'textarea' %}
                          <textarea class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}" rows="2"></textarea>
                        {% else %}
                          <input type="text" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}

                <!-- Global/Shareable Custom Fields -->
                {% if global_fields %}
                  <h6 class="small mb-2 mt-3">Community Custom Fields:</h6>
                  <div class="row">
                    {% for field in global_fields %}
                      <div class="col-md-6 mb-3">
                        <label for="custom_field_{{ field.name }}" class="form-label">
                          {{ field.display_name }}
                          {% if field.description %}
                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="{{ field.description }}"></i>
                          {% endif %}
                        </label>
                        {% if field.field_type.value == 'select' %}
                          <select class="form-select" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                            <option value="">Select...</option>
                            {% for option in field.options %}
                              <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                          </select>
                        {% elif field.field_type.value == 'boolean' %}
                          <select class="form-select" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                            <option value="">Select...</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                          </select>
                        {% elif field.field_type.value == 'number' %}
                          <input type="number" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}" step="any">
                        {% elif field.field_type.value == 'date' %}
                          <input type="date" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                        {% elif field.field_type.value == 'textarea' %}
                          <textarea class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}" rows="2"></textarea>
                        {% else %}
                          <input type="text" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              {% else %}
                <div class="text-center py-3">
                  <i class="bi bi-info-circle text-muted me-2"></i>
                  <span class="text-muted">No custom fields available. You can create custom fields from the Settings page.</span>
                </div>
              {% endif %}
              
              <div class="small help-text mt-2">
                <i class="bi bi-lightbulb me-1"></i>
                Want to create new custom fields? Visit the 
                <a href="{{ url_for('auth.settings') }}" class="text-decoration-none">Settings page</a> 
                to manage your custom fields.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-plus-circle me-1"></i>Add Book to Library
        </button>
      </div>
    </form>
  </div>

  <!-- Bulk Import Tab -->
  <div class="tab-pane fade" id="bulk-import" role="tabpanel">
    <div class="alert alert-info">
      <strong>üìù Background Processing:</strong> Bulk imports run in the background! You'll be redirected to a progress page where you can monitor the import status in real-time.
    </div>
    
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title">CSV Upload</h6>
            <p class="card-text small">Upload a CSV file containing ISBNs/UPCs in a single column.</p>
            <form method="POST" action="{{ url_for('main.import_books') }}" enctype="multipart/form-data">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
              <div class="mb-3">
                <label for="csv-file" class="form-label">Select CSV File</label>
                <input type="file" class="form-control" id="csv-file" name="csv_file" accept=".csv" required>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-upload me-1"></i>Start Import
              </button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title">CSV Format Requirements</h6>
            <p class="card-text small">Your CSV should have ISBNs/UPCs in the first column:</p>
            <pre class="small bg-light p-2 rounded">ISBN
9780143127741
9780525478812
9781594206252</pre>
            <div class="small text-muted mt-2">
              <strong>Note:</strong> Reading status and other preferences will be configured in the next step of the import process.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Load locations on page load
document.addEventListener('DOMContentLoaded', function() {
  loadUserLocations();
  
  // Initialize tooltips for custom field descriptions
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

function loadUserLocations() {
  const locationSelect = document.getElementById('manual-location');
  if (locationSelect) {
    // Add default option
    locationSelect.innerHTML = '<option value="">Select a location...</option>';
    
    // Fetch user locations from the API
    fetch('{{ url_for("locations.api_user_locations") }}')
      .then(response => response.json())
      .then(locations => {
        locations.forEach(location => {
          const option = document.createElement('option');
          option.value = location.id;
          option.textContent = location.name;
          if (location.is_default) {
            option.selected = true;
          }
          locationSelect.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Error loading locations:', error);
        // Add a fallback option
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Error loading locations';
        locationSelect.appendChild(option);
      });
  }
}

function fetchBookData() {
  const isbn = document.getElementById('manual-isbn').value.trim();
  if (!isbn) {
    alert('Please enter an ISBN first.');
    return;
  }
  
  // Show loading state
  const fetchBtn = document.querySelector('button[onclick="fetchBookData()"]');
  const originalText = fetchBtn.innerHTML;
  fetchBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Fetching...';
  fetchBtn.disabled = true;
  
  fetch(`{{ url_for('main.fetch_book', isbn='') }}${isbn}`)
    .then(response => response.json())
    .then(data => {
      if (data.title) document.getElementById('manual-title').value = data.title;
      if (data.author) document.getElementById('manual-author').value = data.author;
      if (data.subtitle) document.getElementById('manual-subtitle').value = data.subtitle;
      if (data.cover) document.getElementById('manual-cover-url').value = data.cover;
      if (data.publisher) document.getElementById('manual-publisher').value = data.publisher;
      if (data.page_count) document.getElementById('manual-page-count').value = data.page_count;
      if (data.published_date) document.getElementById('manual-published-date').value = data.published_date;
      if (data.language) document.getElementById('manual-language').value = data.language;
      if (data.description) document.getElementById('manual-description').value = data.description;
      
      // Handle categories/genres
      if (data.categories) {
        const categories = Array.isArray(data.categories) ? data.categories.join(', ') : data.categories;
        document.getElementById('manual-genres').value = categories;
      }
      
      // Handle series information
      if (data.series) {
        document.getElementById('manual-series').value = data.series;
        if (data.series_volume) document.getElementById('manual-series-volume').value = data.series_volume;
        if (data.series_order) document.getElementById('manual-series-order').value = data.series_order;
      }
    })
    .catch(error => {
      console.error('Error fetching book data:', error);
      alert('Failed to fetch book data. Please try again.');
    })
    .finally(() => {
      // Restore button state
      fetchBtn.innerHTML = originalText;
      fetchBtn.disabled = false;
    });
}

// Handle reading status changes to automatically update dates
document.getElementById('manual-reading-status').addEventListener('change', function() {
  const status = this.value;
  const startDateField = document.getElementById('manual-start-date');
  const finishDateField = document.getElementById('manual-finish-date');
  const today = new Date().toISOString().split('T')[0];
  
  if (status === 'reading' && !startDateField.value) {
    startDateField.value = today;
  } else if (status === 'read' && !finishDateField.value) {
    finishDateField.value = today;
    if (!startDateField.value) {
      // Set start date to a week ago if not specified
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      startDateField.value = weekAgo.toISOString().split('T')[0];
    }
  }
});
</script>

<div class="text-center mt-4">
  <a href="{{ url_for('main.library') }}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i>Back to Library
  </a>
</div>
</div>

{% endblock %}
