<!doctype html>
<html lang="en" data-theme="{{ current_theme }}">
<head>
  <meta charset="utf-8">
  <title>{% block title %}{{ site_name }}{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <!-- Bootstrap CSS (local) -->
  <link href="{{ url_for('serve_static', filename='bootstrap.min.css') }}" rel="stylesheet">
  <!-- Bootstrap Icons (local) -->
  <link href="{{ url_for('serve_static', filename='bootstrap-icons/bootstrap-icons.min.css') }}" rel="stylesheet">
  <style>
    :root {
      /* Light theme variables */
      --bg-color: #f5f5f5;
      --bg-gradient: linear-gradient(to bottom, #f5f5f5, #e0e0e0);
      --overlay-background: rgba(255, 255, 255, 0.15);
      --container-background: rgba(255,255,255,0.95);
      --navbar-background: rgba(255,255,255,0.95);
      --text-color: #333;
      --heading-color: #5a3e1b;
      --link-color: #8d5524;
      --link-hover-color: #c68642;
      --border-color: #e0c9a6;
      --bookshelf-bg: url("{{ url_for('serve_static', filename='bookshelf.png') }}");
      --primary-brown: #8B4513;
      --light-brown: #D2B48C;
      --cream: #F5F5DC;
      --warm-white: #FEFEFE;
      --gold: #FFC107; /* Changed from #DAA520 for better contrast */
      --shadow: rgba(0,0,0,0.1);
      --hover-shadow: rgba(0,0,0,0.2);
    }
    
    [data-theme="dark"] {
      /* Dark theme variables */
      --bg-color: #1a1a1a;
      --bg-gradient: linear-gradient(to bottom, #1a1a1a, #0d0d0d);
      --overlay-background: rgba(0, 0, 0, 0.25);
      --container-background: rgba(30, 30, 30, 0.95);
      --navbar-background: rgba(20, 20, 20, 0.95);
      --text-color: #e0e0e0;
      --heading-color: #d4af7a;
      --link-color: #d4af7a;
      --link-hover-color: #f0c674;
      --border-color: #404040;
      --bookshelf-bg: none;
    }
    
    body {
      background-image: var(--bookshelf-bg), var(--bg-gradient);
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height: 100vh;
      font-family: 'Georgia', serif;
      color: var(--text-color);
    }
    .overlay {
      background: var(--overlay-background);
      min-height: 100vh;
      padding: 40px 0;
    }
    .container {
      width: 100%;
      max-width: none;
      margin: 0 auto;
      border-radius: clamp(8px, 2vw, 16px);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      background: var(--container-background);
      padding: clamp(12px, 3vw, 40px);
      color: var(--text-color);
    }
    
    /* Responsive design improvements */
    @media (max-width: 768px) {
      .container {
        margin: clamp(5px, 2vw, 15px) auto;
        padding: clamp(12px, 4vw, 20px);
        border-radius: clamp(8px, 2vw, 12px);
      }
      
      .overlay {
        padding: clamp(15px, 4vw, 25px) 0;
      }
      
      .navbar {
        margin-bottom: clamp(15px, 4vw, 25px);
      }
      
      .navbar-nav .btn {
        margin-bottom: 8px;
        width: 100%;
        font-size: clamp(0.8rem, 3vw, 1rem);
      }
      
      .navbar-nav {
        text-align: center;
      }
    }
    
    @media (max-width: 576px) {
      .container {
        margin: clamp(2px, 1vw, 8px) auto;
        padding: clamp(8px, 3vw, 16px);
        border-radius: clamp(6px, 1.5vw, 10px);
      }
      
      h1 {
        font-size: clamp(1.2rem, 4vw, 1.8rem);
      }
      
      h2 {
        font-size: clamp(1.1rem, 3.5vw, 1.5rem);
      }
      
      h3 {
        font-size: clamp(1rem, 3vw, 1.3rem);
      }
      
      .navbar-brand {
        font-size: clamp(1rem, 4vw, 1.3rem) !important;
      }
    }
    h1, h2, h3 {
      font-family: 'Georgia', serif;
      color: var(--heading-color);
    }
    a {
      color: var(--link-color);
      text-decoration: none;
    }
    a:hover {
      color: var(--link-hover-color);
      text-decoration: underline;
    }
    .btn-link {
      color: var(--link-color);
      text-decoration: none;
    }
    .btn-link:hover {
      color: var(--link-hover-color);
      text-decoration: underline;
    }
    .book-cover {
      max-height: 220px;
      margin-bottom: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .navbar {
      background: var(--navbar-background);
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 32px;
    }
    
    /* Additional responsive improvements */
    @media (max-width: 991px) {
      .navbar-nav .btn {
        margin-bottom: 0.5rem;
        margin-right: 0 !important;
        width: 100%;
      }
      
      .navbar-nav {
        margin-top: 1rem;
      }
      
      .navbar-text {
        font-size: clamp(0.8rem, 2.5vw, 1rem);
        margin-bottom: 0.5rem;
      }
    }
    
    /* Fully responsive typography */
    .navbar-brand {
      font-size: clamp(1.1rem, 3.5vw, 1.8rem);
      font-weight: bold;
    }
    
    /* Adaptive spacing for all screen sizes */
    .navbar-nav .btn {
      font-size: clamp(0.75rem, 2.5vw, 1rem);
      padding: clamp(0.3rem, 1.5vw, 0.6rem) clamp(0.8rem, 3vw, 1.2rem);
      border-radius: clamp(0.25rem, 1vw, 0.5rem);
    }
    
    /* Container fluid adjustments */
    .container-fluid {
      padding-left: clamp(8px, 2vw, 24px);
      padding-right: clamp(8px, 2vw, 24px);
    }
    
    /* Adaptive overlay background */
    .overlay {
      padding: clamp(20px, 5vw, 50px) clamp(8px, 2vw, 20px);
    }
    .social-icons {
      display: flex;
      justify-content: center;
      gap: 18px;
      align-items: center;
    }
    .social-icon {
      width: 40px !important;
      height: 40px !important;
      font-size: 40px !important;
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      transition: opacity 0.2s;
      vertical-align: middle;
      padding: 0;
      background: none;
      border: none;
    }
    .social-icon:hover {
      opacity: 1;
    }
    .social-icon img,
    .social-icon svg {
      width: 40px !important;
      height: 40px !important;
      display: block;
    }
    
    /* Dark mode specific styles */
    [data-theme="dark"] .navbar-light .navbar-brand {
      color: var(--text-color) !important;
    }
    
    [data-theme="dark"] .navbar-light .navbar-nav .nav-link {
      color: var(--text-color) !important;
    }
    
    [data-theme="dark"] .navbar-light .navbar-toggler {
      border-color: var(--border-color);
    }
    
    [data-theme="dark"] .navbar-text {
      color: var(--text-color) !important;
    }
    
    [data-theme="dark"] .alert {
      background-color: rgba(40, 40, 40, 0.9);
      border-color: var(--border-color);
      color: var(--text-color);
    }
    
    /* Contemporary Navbar Button Styling for Light Mode */
    .navbar .btn-outline-primary {
      border-color: #4A90E2 !important;
      color: #4A90E2 !important;
      background: rgba(74, 144, 226, 0.08) !important;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .navbar .btn-outline-primary:hover {
      background-color: #4A90E2 !important;
      border-color: #4A90E2 !important;
      color: white !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
    }
    
    .navbar .btn-outline-success {
      border-color: #00C851 !important;
      color: #00C851 !important;
      background: rgba(0, 200, 81, 0.08) !important;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .navbar .btn-outline-success:hover {
      background-color: #00C851 !important;
      border-color: #00C851 !important;
      color: white !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 200, 81, 0.3);
    }
    
    .navbar .btn-outline-info {
      border-color: #17A2B8 !important;
      color: #17A2B8 !important;
      background: rgba(23, 162, 184, 0.08) !important;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .navbar .btn-outline-info:hover {
      background-color: #17A2B8 !important;
      border-color: #17A2B8 !important;
      color: white !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
    }
    
    .navbar .btn-outline-warning {
      border-color: #FF8800 !important;
      color: #FF8800 !important;
      background: rgba(255, 136, 0, 0.08) !important;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .navbar .btn-outline-warning:hover {
      background-color: #FF8800 !important;
      border-color: #FF8800 !important;
      color: white !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(255, 136, 0, 0.3);
    }
    
    .navbar .btn-outline-secondary {
      border-color: #6C757D !important;
      color: #6C757D !important;
      background: rgba(108, 117, 125, 0.08) !important;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .navbar .btn-outline-secondary:hover {
      background-color: #6C757D !important;
      border-color: #6C757D !important;
      color: white !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
    }
    
    .navbar .btn-outline-danger {
      border-color: #DC3545 !important;
      color: #DC3545 !important;
      background: rgba(220, 53, 69, 0.08) !important;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .navbar .btn-outline-danger:hover {
      background-color: #DC3545 !important;
      border-color: #DC3545 !important;
      color: white !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }

    /* Contemporary Dark Mode Navbar Button Styling */
    [data-theme="dark"] .navbar .btn-outline-primary {
      border-color: #5A9EFF !important;
      color: #5A9EFF !important;
      background: rgba(90, 158, 255, 0.12) !important;
    }
    
    [data-theme="dark"] .navbar .btn-outline-primary:hover {
      background-color: #5A9EFF !important;
      border-color: #5A9EFF !important;
      color: #000 !important;
      box-shadow: 0 2px 12px rgba(90, 158, 255, 0.4);
    }
    
    [data-theme="dark"] .navbar .btn-outline-success {
      border-color: #00E676 !important;
      color: #00E676 !important;
      background: rgba(0, 230, 118, 0.12) !important;
    }
    
    [data-theme="dark"] .navbar .btn-outline-success:hover {
      background-color: #00E676 !important;
      border-color: #00E676 !important;
      color: #000 !important;
      box-shadow: 0 2px 12px rgba(0, 230, 118, 0.4);
    }
    
    [data-theme="dark"] .navbar .btn-outline-info {
      border-color: #26C6DA !important;
      color: #26C6DA !important;
      background: rgba(38, 198, 218, 0.12) !important;
    }
    
    [data-theme="dark"] .navbar .btn-outline-info:hover {
      background-color: #26C6DA !important;
      border-color: #26C6DA !important;
      color: #000 !important;
      box-shadow: 0 2px 12px rgba(38, 198, 218, 0.4);
    }
    
    [data-theme="dark"] .navbar .btn-outline-warning {
      border-color: #FFB74D !important;
      color: #FFB74D !important;
      background: rgba(255, 183, 77, 0.12) !important;
    }
    
    [data-theme="dark"] .navbar .btn-outline-warning:hover {
      background-color: #FFB74D !important;
      border-color: #FFB74D !important;
      color: #000 !important;
      box-shadow: 0 2px 12px rgba(255, 183, 77, 0.4);
    }
    
    [data-theme="dark"] .navbar .btn-outline-secondary {
      border-color: #9E9E9E !important;
      color: #9E9E9E !important;
      background: rgba(158, 158, 158, 0.12) !important;
    }
    
    [data-theme="dark"] .navbar .btn-outline-secondary:hover {
      background-color: #9E9E9E !important;
      border-color: #9E9E9E !important;
      color: #000 !important;
      box-shadow: 0 2px 12px rgba(158, 158, 158, 0.4);
    }
    
    [data-theme="dark"] .navbar .btn-outline-danger {
      border-color: #FF5252 !important;
      color: #FF5252 !important;
      background: rgba(255, 82, 82, 0.12) !important;
    }
    
    [data-theme="dark"] .navbar .btn-outline-danger:hover {
      background-color: #FF5252 !important;
      border-color: #FF5252 !important;
      color: #000 !important;
      box-shadow: 0 2px 12px rgba(255, 82, 82, 0.4);
    }
    
    /* Improved Library Status Box Styling - Fix for hover washout issue */
    .filter-btn.btn-outline-warning:hover,
    .filter-btn.btn-outline-success:hover,
    .filter-btn.btn-outline-info:hover,
    .filter-btn.btn-outline-primary:hover,
    .filter-btn.btn-outline-secondary:hover,
    .filter-btn.btn-outline-dark:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      border-width: 2px !important;
    }
    
    /* Ensure text remains readable on hover for filter buttons */
    .filter-btn.btn-outline-warning:hover .h4,
    .filter-btn.btn-outline-warning:hover small {
      color: #000 !important;
    }
    
    .filter-btn.btn-outline-success:hover .h4,
    .filter-btn.btn-outline-success:hover small {
      color: #fff !important;
    }
    
    .filter-btn.btn-outline-info:hover .h4,
    .filter-btn.btn-outline-info:hover small {
      color: #fff !important;
    }
    
    .filter-btn.btn-outline-primary:hover .h4,
    .filter-btn.btn-outline-primary:hover small {
      color: #fff !important;
    }
    
    .filter-btn.btn-outline-secondary:hover .h4,
    .filter-btn.btn-outline-secondary:hover small {
      color: #fff !important;
    }
    
    .filter-btn.btn-outline-dark:hover .h4,
    .filter-btn.btn-outline-dark:hover small {
      color: #fff !important;
    }
    
    /* Dark mode improvements for filter buttons */
    [data-theme="dark"] .filter-btn.btn-outline-warning:hover .h4,
    [data-theme="dark"] .filter-btn.btn-outline-warning:hover small {
      color: #000 !important;
    }
    
    [data-theme="dark"] .filter-btn.btn-outline-success:hover .h4,
    [data-theme="dark"] .filter-btn.btn-outline-success:hover small {
      color: #000 !important;
    }
    
    [data-theme="dark"] .filter-btn.btn-outline-info:hover .h4,
    [data-theme="dark"] .filter-btn.btn-outline-info:hover small {
      color: #000 !important;
    }
    
    [data-theme="dark"] .filter-btn.btn-outline-primary:hover .h4,
    [data-theme="dark"] .filter-btn.btn-outline-primary:hover small {
      color: #000 !important;
    }
    
    [data-theme="dark"] .filter-btn.btn-outline-secondary:hover .h4,
    [data-theme="dark"] .filter-btn.btn-outline-secondary:hover small {
      color: #000 !important;
    }
    
    [data-theme="dark"] .filter-btn.btn-outline-dark:hover .h4,
    [data-theme="dark"] .filter-btn.btn-outline-dark:hover small {
      color: #fff !important;
    }
    
    [data-theme="dark"] .badge {
      background-color: #495057 !important;
      color: var(--text-color);
    }
    
    [data-theme="dark"] .form-control {
      background-color: #2d2d2d;
      border-color: var(--border-color);
      color: var(--text-color);
    }
    
    [data-theme="dark"] .form-control:focus {
      background-color: #2d2d2d;
      border-color: #86b7fe;
      color: var(--text-color);
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    [data-theme="dark"] .form-control::placeholder {
      color: #999;
    }
    
    [data-theme="dark"] .form-select {
      background-color: #2d2d2d;
      border-color: var(--border-color);
      color: var(--text-color);
    }
    
    [data-theme="dark"] .table {
      color: var(--text-color);
    }
    
    [data-theme="dark"] .table-striped > tbody > tr:nth-of-type(odd) > td {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    [data-theme="dark"] .card {
      background-color: rgba(40, 40, 40, 0.8);
      border-color: var(--border-color);
      color: var(--text-color);
    }
    
    [data-theme="dark"] .card-header {
      background-color: rgba(60, 60, 60, 0.8);
      border-bottom-color: var(--border-color);
    }

    [data-theme="dark"] .stat-card,
    [data-theme="dark"] .community-stat-card,
    [data-theme="dark"] .reading-activity {
        background: rgba(40, 40, 40, 0.8) !important;
        border-color: var(--border-color) !important;
    }

    [data-theme="dark"] .stat-number {
        color: var(--heading-color) !important;
    }

    [data-theme="dark"] .stat-label {
        color: #aaa !important;
    }

    /* Add Book Page Dark Mode Styles */
    [data-theme="dark"] .tab-content {
      background: #2c2c2c;
      border-color: #444;
    }
    [data-theme="dark"] .nav-tabs .nav-link {
      color: #ccc;
    }
    [data-theme="dark"] .nav-tabs .nav-link.active {
      color: #fff;
    }
    [data-theme="dark"] .card {
      background-color: #333;
    }
    [data-theme="dark"] pre {
      background-color: #222 !important;
      color: #eee;
    }
    
    /* Additional dark mode text styling */
    [data-theme="dark"] p {
      color: var(--text-color) !important;
    }
    
    [data-theme="dark"] .lead {
      color: var(--text-color) !important;
    }
    
    [data-theme="dark"] div {
      color: var(--text-color);
    }
    
    [data-theme="dark"] span {
      color: var(--text-color);
    }
    
    /* Ensure heading colors are properly applied */
    [data-theme="dark"] h1,
    [data-theme="dark"] h2,
    [data-theme="dark"] h3,
    [data-theme="dark"] h4,
    [data-theme="dark"] h5,
    [data-theme="dark"] h6 {
      color: var(--heading-color) !important;
    }
    
    .btn-success {
      background-color: var(--gold);
      border-color: var(--gold);
      color: #000; /* Changed from #333 for better contrast */
    }

    .btn-success:hover {
      background-color: #FFA000; /* Darker gold for hover */
      border-color: #FFA000;
      color: #000;
    }
  </style>
</head>
<body>
  <div class="overlay">
    {% block navbar %}
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('main.library') }}"><strong>MyBibliotheca</strong></a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNav">
          <div class="navbar-nav me-auto">
            {% if current_user.is_authenticated %}
              <a class="btn btn-outline-primary me-2" href="{{ url_for('main.library') }}">Library</a>
              <a class="btn btn-outline-info me-2" href="{{ url_for('main.people') }}">People</a>
              <a class="btn btn-outline-secondary me-2" href="{{ url_for('genres.index') }}">Genres</a>
              <a class="btn btn-outline-success me-2" href="{{ url_for('main.stats') }}">Stats</a>
              <a class="btn btn-outline-info me-2" href="{{ url_for('locations.manage_locations') }}">Locations</a>
              <a class="btn btn-outline-warning me-2" href="{{ url_for('metadata.index') }}">Metadata</a>
              <a class="btn btn-outline-secondary me-2" href="{{ url_for('auth.settings') }}">Settings</a>
            {% endif %}
          </div>
          
          <div class="navbar-nav">
            <!-- Dark mode toggle -->
            <button id="theme-toggle" class="btn btn-outline-secondary me-2" title="Toggle dark mode">
              <i class="bi bi-moon-fill" id="theme-icon"></i>
            </button>
            
            {% if current_user.is_authenticated %}
              <span class="navbar-text me-3">
                Welcome, {{ current_user.username }}
                {% if current_user.is_admin %}
                  <span class="badge bg-danger ms-1">Admin</span>
                {% endif %}
              </span>
              <a class="btn btn-outline-danger" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right"></i> Logout</a>
            {% else %}
              <a class="btn btn-outline-primary me-2" href="{{ url_for('auth.login') }}">Login</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
    {% endblock %}
    <div class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} mt-2">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}
        <a href="{{ url_for('main.view_book_enhanced', uid=book.uid) }}"><strong>{{ book.title }}</strong></a>
      {% endblock %}
      <div class="text-center mt-4">
        <div class="social-icons">
          <a href="https://github.com/pickles4evaaaa/mybibliotheca" target="_blank" rel="noopener" title="View on GitHub" class="social-icon">
            <img src="{{ url_for('serve_static', filename='github-mark.png') }}" alt="GitHub">
          </a>
          <a href="https://discord.gg/Hc8C5eRm7Q" target="_blank" rel="noopener" title="Join our Discord" class="social-icon">
            <i class="bi bi-discord" style="color: #5865F2;"></i>
          </a>
          <a href="https://x.com/my_bibliotheca" target="_blank" rel="noopener" title="Follow us on X (Twitter)" class="social-icon">
            <i class="bi bi-twitter-x" style="color: #000;"></i>
          </a>
          <a href="https://bsky.app/profile/mybibliotheca.org" target="_blank" rel="noopener" title="Follow us on Bluesky" class="social-icon">
            <svg viewBox="0 0 568 501" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.209C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86-120.404-209.185-135.713-209.185-135.713s-89.325 15.309-209.185 135.713C-8.056 388.56 21.167 323.8 135.631 304.25c-65.72 11.185-139.6-7.295-159.875-79.748C-9.945 203.66-20 75.293-20 57.947c0-86.853 76.134-59.558 123.121-24.283Z" fill="#1185fe"/>
            </svg>
          </a>
        </div>
        <div style="font-size: 1.1em; color: #888; margin-top: 4px;">MyBibliotheca db-upgrade0.1 | It is highly recommended to backup your database regularly.</div>
      </div>
      {% block footer %}
      <footer class="text-center mt-4">
        <a href="{{ url_for('main.download_db') }}" class="btn btn-primary" style="margin-top: 8px;">Download Database</a>
      </footer>
      {% endblock %}
    </div>
  </div>
  <!-- Bootstrap JS (local file) -->
  <script src="{{ url_for('serve_static', filename='bootstrap.bundle.min.js') }}"></script>
  
  <!-- Global CSRF utilities -->
  <script>
    // Make CSRF token globally available
    window.csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Utility function to add CSRF token to forms
    function addCSRFToForm(form) {
      if (!form.querySelector('input[name="csrf_token"]')) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = window.csrfToken;
        form.appendChild(csrfInput);
      }
    }
    
    // Utility function for CSRF-protected fetch requests
    function csrfFetch(url, options = {}) {
      options.headers = options.headers || {};
      options.headers['X-CSRFToken'] = window.csrfToken;
      return fetch(url, options);
    }
    
    // Auto-add CSRF to all forms on page load
    document.addEventListener('DOMContentLoaded', function() {
      const forms = document.querySelectorAll('form[method="post"], form[method="POST"]');
      forms.forEach(addCSRFToForm);
      
      // Initialize theme toggle
      initThemeToggle();
    });
    
    // Theme toggle functionality
    function initThemeToggle() {
      const themeToggle = document.getElementById('theme-toggle');
      const themeIcon = document.getElementById('theme-icon');
      const htmlElement = document.documentElement;
      
      // Check if localStorage has a different theme than server-side
      const serverTheme = htmlElement.getAttribute('data-theme') || 'light';
      const localStorageTheme = localStorage.getItem('mybibliotheca_theme');
      
      // If localStorage has a different theme, use that and sync with server
      if (localStorageTheme && localStorageTheme !== serverTheme) {
        htmlElement.setAttribute('data-theme', localStorageTheme);
        // Sync with server in background
        csrfFetch('{{ url_for("main.toggle_theme") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            current_theme: serverTheme
          })
        }).catch(error => {
          console.log('Failed to sync theme with server:', error);
        });
      }
      
      // Update icon based on current theme
      function updateThemeIcon(theme) {
        if (theme === 'dark') {
          themeIcon.className = 'bi bi-sun-fill';
        } else {
          themeIcon.className = 'bi bi-moon-fill';
        }
      }
      
      // Initialize icon
      const currentTheme = htmlElement.getAttribute('data-theme') || 'light';
      updateThemeIcon(currentTheme);
      
      // Theme toggle click handler
      themeToggle.addEventListener('click', function() {
        const currentTheme = htmlElement.getAttribute('data-theme') || 'light';
        
        // Send theme toggle request
        csrfFetch('{{ url_for("main.toggle_theme") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            current_theme: currentTheme
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update theme immediately
            htmlElement.setAttribute('data-theme', data.new_theme);
            updateThemeIcon(data.new_theme);
            
            // Store theme preference in localStorage as backup
            localStorage.setItem('mybibliotheca_theme', data.new_theme);
          } else {
            console.error('Failed to toggle theme:', data.error);
          }
        })
        .catch(error => {
          console.error('Error toggling theme:', error);
          // If server request fails, toggle locally and store in localStorage
          const newTheme = currentTheme === 'light' ? 'dark' : 'light';
          htmlElement.setAttribute('data-theme', newTheme);
          updateThemeIcon(newTheme);
          localStorage.setItem('mybibliotheca_theme', newTheme);
        });
      });
    }
  </script>
</body>
</html>