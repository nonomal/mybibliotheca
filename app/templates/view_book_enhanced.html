{% extends "base.html" %}
{% from 'macros/contributors.html' import display_authors, display_narrators, display_editors %}
{% block title %}{{ book.title }} - Bibliotheca{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.library') }}">Library</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ book.title }}</li>
                </ol>
            </nav>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('main.library') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to Library
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Book Overview Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body position-relative">
                    <!-- Action Icons in Upper Right Corner -->
                    <div class="position-absolute top-0 end-0 mt-2 me-2">
                        <div class="d-flex gap-1">
                            <a href="{{ url_for('main.edit_book', uid=book.uid) }}" 
                               class="btn btn-outline-primary btn-sm p-1 action-icon-btn" 
                               title="Edit Book Details">
                                <i class="bi bi-pencil" style="font-size: 0.875rem;"></i>
                            </a>
                            <form method="post" action="{{ url_for('main.delete_book', uid=book.uid) }}" 
                                  class="d-inline" onsubmit="return confirm('Are you sure you want to delete this book from your library?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-outline-danger btn-sm p-1 action-icon-btn" 
                                        title="Remove from Library">
                                    <i class="bi bi-trash" style="font-size: 0.875rem;"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 text-center mb-3 mb-md-0">
                            <div class="position-relative d-inline-block">
                                {% if book.cover_url %}
                                    <img src="{{ book.cover_url }}" alt="{{ book.title }}" 
                                         class="img-fluid rounded shadow-sm" style="max-height: 300px;" id="book-cover-img">
                                {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                                         style="height: 300px; max-width: 200px; margin: 0 auto;" id="book-cover-placeholder">
                                        <i class="bi bi-book text-muted" style="font-size: 4rem;"></i>
                                    </div>
                                {% endif %}
                                
                                <!-- Cover Edit Icon -->
                                <button type="button" class="btn btn-outline-secondary btn-sm cover-edit-btn" 
                                        data-bs-toggle="modal" data-bs-target="#coverEditModal" 
                                        title="Edit Book Cover">
                                    <i class="bi bi-pencil" style="font-size: 0.75rem;"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-9">
                            <h1 class="h2 mb-2 fw-bold">{{ book.title }}</h1>
                            {% if book.subtitle %}
                                <h2 class="h5 text-muted mb-3">{{ book.subtitle }}</h2>
                            {% endif %}
                            
                            <!-- Contributors -->
                            {% if book.authors %}
                                <p class="h6 text-primary mb-2">
                                    {{ display_authors(book, show_icon=true, style_class="") }}
                                </p>
                            {% endif %}
                            
                            {% if book.narrators %}
                                <p class="h6 text-info mb-2">
                                    {{ display_narrators(book, show_icon=true, style_class="") }}
                                </p>
                            {% endif %}
                            
                            {% if book.editors %}
                                <p class="h6 text-secondary mb-2">
                                    {{ display_editors(book, show_icon=true, style_class="") }}
                                </p>
                            {% endif %}
                            
                            <!-- Book Meta Information -->
                            <div class="row g-3 mb-3">
                                {% if book.isbn %}
                                <div class="col-sm-6">
                                    <small class="text-muted d-block">ISBN</small>
                                    <span class="fw-medium">{{ book.isbn }}</span>
                                </div>
                                {% endif %}
                                
                                {% if book.isbn13 and book.isbn13 != book.isbn %}
                                <div class="col-sm-6">
                                    <small class="text-muted d-block">ISBN-13</small>
                                    <span class="fw-medium">{{ book.isbn13 }}</span>
                                </div>
                                {% endif %}
                                
                                {% if book.isbn10 and book.isbn10 != book.isbn %}
                                <div class="col-sm-6">
                                    <small class="text-muted d-block">ISBN-10</small>
                                    <span class="fw-medium">{{ book.isbn10 }}</span>
                                </div>
                                {% endif %}
                                
                                {% if book.publisher %}
                                <div class="col-sm-6">
                                    <small class="text-muted d-block">Publisher</small>
                                    <span class="fw-medium">{{ book.publisher.name if book.publisher.name else book.publisher }}</span>
                                </div>
                                {% endif %}
                                
                                {% if book.page_count %}
                                <div class="col-sm-6">
                                    <small class="text-muted d-block">Pages</small>
                                    <span class="fw-medium">{{ book.page_count }}</span>
                                </div>
                                {% endif %}
                                
                                {% if book.published_date %}
                                <div class="col-sm-6">
                                    <small class="text-muted d-block">Published</small>
                                    <span class="fw-medium">{{ book.published_date }}</span>
                                </div>
                                {% endif %}
                                
                                {% if book.language and book.language != 'en' %}
                                <div class="col-sm-6">
                                    <small class="text-muted d-block">Language</small>
                                    <span class="fw-medium">
                                        {% if book.language == 'es' %}Spanish
                                        {% elif book.language == 'fr' %}French
                                        {% elif book.language == 'de' %}German
                                        {% elif book.language == 'it' %}Italian
                                        {% elif book.language == 'pt' %}Portuguese
                                        {% elif book.language == 'ru' %}Russian
                                        {% elif book.language == 'ja' %}Japanese
                                        {% elif book.language == 'ko' %}Korean
                                        {% elif book.language == 'zh' %}Chinese
                                        {% else %}{{ book.language }}
                                        {% endif %}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if book.series %}
                                <div class="col-sm-6">
                                    <small class="text-muted d-block">Series</small>
                                    <span class="fw-medium">
                                        {{ book.series.name if book.series.name else book.series }}
                                        {% if book.series_volume %} - {{ book.series_volume }}{% endif %}
                                        {% if book.series_order %} (#{{ book.series_order }}){% endif %}
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Categories/Genres -->
                            {% if book_categories %}
                            <div class="mb-3">
                                <small class="text-muted d-block mb-1">
                                    <i class="bi bi-tags me-1"></i>Genres & Categories
                                </small>
                                {% for category in book_categories %}
                                    <a href="{{ url_for('genres.category_details', category_id=category.id) }}" 
                                       class="badge bg-light text-dark border me-1 mb-1 text-decoration-none" 
                                       title="Category: {{ category.name }}{% if category.description %} - {{ category.description }}{% endif %}">
                                        {{ category.name }}
                                    </a>
                                {% endfor %}
                            </div>
                            {% elif book.categories %}
                            <!-- Categories from domain model -->
                            <div class="mb-3">
                                <small class="text-muted d-block mb-1">
                                    <i class="bi bi-tags me-1"></i>Categories
                                </small>
                                {% for category in book.categories %}
                                    <span class="badge bg-light text-dark border me-1 mb-1">{{ category.name }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Rating -->
                            {% if book.average_rating %}
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-2">
                                    {% for i in range(5) %}
                                        {% if i < book.average_rating %}
                                            <i class="bi bi-star-fill text-warning"></i>
                                        {% else %}
                                            <i class="bi bi-star text-muted"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="fw-medium">{{ "%.1f"|format(book.average_rating) }}</span>
                                {% if book.rating_count %}
                                    <small class="text-muted ms-1">({{ book.rating_count }} ratings)</small>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Description -->
            {% if book.description %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Description</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ book.description }}</p>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Accordion for collapsible sections -->
            <div class="accordion" id="bookAccordion">
                <!-- Book Status -->
                <div class="accordion-item shadow-sm mb-2">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-primary text-white" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapseStatus" 
                                aria-expanded="false" aria-controls="collapseStatus">
                            <i class="bi bi-bookmark-fill me-2"></i>Book Status
                        </button>
                    </h2>
                    <div id="collapseStatus" class="accordion-collapse collapse" data-bs-parent="#bookAccordion">
                        <div class="accordion-body">
                            <form method="post" action="{{ url_for('main.update_book_details', uid=book.uid) }}" id="status-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                
                                <!-- Reading Status -->
                                <div class="mb-3">
                                    <label for="reading_status" class="form-label fw-medium">
                                        <i class="bi bi-book me-1"></i>Reading Status
                                    </label>
                                    <select class="form-select" id="reading_status" name="reading_status">
                                        <option value="plan_to_read" {% if book.reading_status == 'plan_to_read' %}selected{% endif %}>📚 Plan to Read</option>
                                        <option value="reading" {% if book.reading_status == 'reading' %}selected{% endif %}>📖 Currently Reading</option>
                                        <option value="read" {% if book.reading_status == 'read' %}selected{% endif %}>✅ Read</option>
                                        <option value="on_hold" {% if book.reading_status == 'on_hold' %}selected{% endif %}>⏸️ On Hold</option>
                                        <option value="did_not_finish" {% if book.reading_status == 'did_not_finish' %}selected{% endif %}>❌ Did Not Finish</option>
                                        <option value="library_only" {% if book.reading_status == 'library_only' %}selected{% endif %}>📚 Library Only</option>
                                    </select>
                                </div>
                                
                                <!-- Ownership Status -->
                                <div class="mb-3">
                                    <label for="ownership_status" class="form-label fw-medium">
                                        <i class="bi bi-house me-1"></i>Ownership
                                    </label>
                                    <select class="form-select" id="ownership_status" name="ownership_status">
                                        <option value="owned" {% if book.ownership_status == 'owned' %}selected{% endif %}>🏠 Owned</option>
                                        <option value="borrowed" {% if book.ownership_status == 'borrowed' %}selected{% endif %}>📚 Borrowed</option>
                                        <option value="loaned" {% if book.ownership_status == 'loaned' %}selected{% endif %}>📤 Loaned Out</option>
                                        <option value="wishlist" {% if book.ownership_status == 'wishlist' %}selected{% endif %}>⭐ Wishlist</option>
                                    </select>
                                </div>
                                
                                <!-- Media Type -->
                                <div class="mb-3">
                                    <label for="media_type" class="form-label fw-medium">
                                        <i class="bi bi-collection me-1"></i>Format
                                    </label>
                                    <select class="form-select" id="media_type" name="media_type">
                                        <option value="physical" {% if book.media_type == 'physical' %}selected{% endif %}>📖 Physical Book</option>
                                        <option value="ebook" {% if book.media_type == 'ebook' %}selected{% endif %}>💻 E-book</option>
                                        <option value="audiobook" {% if book.media_type == 'audiobook' %}selected{% endif %}>🎧 Audiobook</option>
                                        <option value="kindle" {% if book.media_type == 'kindle' %}selected{% endif %}>📱 Kindle</option>
                                    </select>
                                </div>
                                
                                <!-- Location (for physical books) -->
                                <div class="mb-3" id="location-section">
                                    <label for="location_id" class="form-label fw-medium">
                                        <i class="bi bi-geo-alt me-1"></i>Location
                                    </label>
                                    <select class="form-select" id="location_id" name="location_id">
                                        <option value="">Select location...</option>
                                    </select>
                                    <div class="form-text">
                                        <a href="{{ url_for('locations.manage_locations') }}" target="_blank" class="text-decoration-none">
                                            <i class="bi bi-gear me-1"></i>Manage Locations
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Borrowing Details -->
                                <div id="borrowed-section" class="border rounded p-3 mb-3 bg-light" style="display: none;">
                                    <h6 class="text-primary mb-2"><i class="bi bi-arrow-down-circle me-1"></i>Borrowing Details</h6>
                                    <div class="mb-2">
                                        <label for="borrowed_from" class="form-label">Borrowed From</label>
                                        <input type="text" class="form-control form-control-sm" id="borrowed_from" name="borrowed_from" 
                                               value="{{ book.borrowed_from or '' }}" placeholder="Name or contact">
                                    </div>
                                    <div class="mb-2">
                                        <label for="borrowed_due_date" class="form-label">Due Date</label>
                                        <input type="date" class="form-control form-control-sm" id="borrowed_due_date" name="borrowed_due_date" 
                                               value="{{ book.borrowed_due_date or '' }}">
                                    </div>
                                </div>
                                
                                <!-- Loaning Details -->
                                <div id="loaned-section" class="border rounded p-3 mb-3 bg-light" style="display: none;">
                                    <h6 class="text-warning mb-2"><i class="bi bi-arrow-up-circle me-1"></i>Loaning Details</h6>
                                    <div class="mb-2">
                                        <label for="loaned_to" class="form-label">Loaned To</label>
                                        <input type="text" class="form-control form-control-sm" id="loaned_to" name="loaned_to" 
                                               value="{{ book.loaned_to or '' }}" placeholder="Name or contact">
                                    </div>
                                    <div class="mb-2">
                                        <label for="loaned_due_date" class="form-label">Expected Return</label>
                                        <input type="date" class="form-control form-control-sm" id="loaned_due_date" name="loaned_due_date" 
                                               value="{{ book.loaned_due_date or '' }}">
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle me-1"></i>Update Status
                                    </button>
                                    <button type="submit" name="redirect_to_library" value="true" class="btn btn-outline-primary">
                                        <i class="bi bi-arrow-left me-1"></i>Save & Go to Library
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Reading Progress -->
                <div class="accordion-item shadow-sm mb-2">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-success text-white" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapseProgress" 
                                aria-expanded="false" aria-controls="collapseProgress">
                            <i class="bi bi-calendar-check me-2"></i>Reading Progress
                        </button>
                    </h2>
                    <div id="collapseProgress" class="accordion-collapse collapse" data-bs-parent="#bookAccordion">
                        <div class="accordion-body">
                            <form method="post" action="{{ url_for('main.update_reading_dates', uid=book.uid) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="mb-3">
                                    <label for="start_date" class="form-label fw-medium">
                                        <i class="bi bi-play-circle me-1"></i>Start Date
                                    </label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" 
                                           value="{{ book.start_date or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="finish_date" class="form-label fw-medium">
                                        <i class="bi bi-check-circle me-1"></i>Finish Date
                                    </label>
                                    <input type="date" class="form-control" id="finish_date" name="finish_date" 
                                           value="{{ book.finish_date or '' }}">
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-save me-1"></i>Update Dates
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Personal Notes & Rating -->
                <div class="accordion-item shadow-sm mb-2">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-info text-white" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapseNotes" 
                                aria-expanded="false" aria-controls="collapseNotes">
                            <i class="bi bi-journal-text me-2"></i>Personal Notes
                        </button>
                    </h2>
                    <div id="collapseNotes" class="accordion-collapse collapse" data-bs-parent="#bookAccordion">
                        <div class="accordion-body">
                            <form method="post" action="{{ url_for('main.update_book_notes', uid=book.uid) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                
                                <!-- Your Rating -->
                                <div class="mb-3">
                                    <label for="user_rating" class="form-label fw-medium">
                                        <i class="bi bi-star me-1"></i>Your Rating
                                    </label>
                                    <select class="form-select" id="user_rating" name="user_rating">
                                        <option value="">No rating</option>
                                        <option value="1" {% if book.user_rating == 1 %}selected{% endif %}>⭐ Poor (1 star)</option>
                                        <option value="2" {% if book.user_rating == 2 %}selected{% endif %}>⭐⭐ Fair (2 stars)</option>
                                        <option value="3" {% if book.user_rating == 3 %}selected{% endif %}>⭐⭐⭐ Good (3 stars)</option>
                                        <option value="4" {% if book.user_rating == 4 %}selected{% endif %}>⭐⭐⭐⭐ Very Good (4 stars)</option>
                                        <option value="5" {% if book.user_rating == 5 %}selected{% endif %}>⭐⭐⭐⭐⭐ Excellent (5 stars)</option>
                                    </select>
                                </div>
                                
                                <!-- Notes -->
                                <div class="mb-3">
                                    <label for="personal_notes" class="form-label fw-medium">
                                        <i class="bi bi-chat-square-text me-1"></i>Notes
                                    </label>
                                    <textarea class="form-control" id="personal_notes" name="personal_notes" 
                                              rows="4" placeholder="Your thoughts, quotes, or notes about this book...">{{ book.personal_notes or '' }}</textarea>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-info">
                                        <i class="bi bi-save me-1"></i>Save Notes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Custom Metadata -->
                <div class="accordion-item shadow-sm mb-2">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-warning text-dark" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapseCustomMetadata" 
                                aria-expanded="false" aria-controls="collapseCustomMetadata">
                            <i class="bi bi-tags me-2"></i>Custom Metadata
                        </button>
                    </h2>
                    <div id="collapseCustomMetadata" class="accordion-collapse collapse" data-bs-parent="#bookAccordion">
                        <div class="accordion-body">
                            <!-- Global Metadata -->
                            {% if global_metadata_display %}
                            <div class="mb-3">
                                <h6 class="text-muted">
                                    <i class="bi bi-globe me-1"></i>Global Metadata
                                </h6>
                                {% for meta in global_metadata_display %}
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="fw-medium">{{ meta.display_name }}:</span>
                                    <span class="text-end">{{ meta.display_value | safe }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Personal Metadata -->
                            {% if personal_metadata_display %}
                            <div class="mb-3">
                                {% if global_metadata_display %}<hr>{% endif %}
                                <h6 class="text-muted">
                                    <i class="bi bi-person me-1"></i>Personal Metadata
                                </h6>
                                {% for meta in personal_metadata_display %}
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="fw-medium">{{ meta.display_name }}:</span>
                                    <span class="text-end">{{ meta.display_value | safe }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Edit Button -->
                            <div class="d-grid">
                                <a href="{{ url_for('main.edit_book_custom_metadata', uid=book.uid) }}" class="btn btn-warning">
                                    <i class="bi bi-pencil me-1"></i>Edit Custom Metadata
                                </a>
                            </div>
                            
                            {% if not global_metadata_display and not personal_metadata_display %}
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-plus-circle mb-2" style="font-size: 2rem;"></i>
                                <p class="mb-0">No custom metadata yet.</p>
                                <p class="small">Add custom fields to track additional book information.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cover Edit Modal -->
<div class="modal fade" id="coverEditModal" tabindex="-1" aria-labelledby="coverEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="coverEditModalLabel">
                    <i class="bi bi-image me-2"></i>Edit Book Cover
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <!-- Current Cover Preview -->
                        <div class="text-center mb-3">
                            <h6 class="text-muted mb-2">Current Cover</h6>
                            <div class="cover-preview-container">
                                {% if book.cover_url %}
                                    <img src="{{ book.cover_url }}" alt="{{ book.title }}" 
                                         class="img-fluid rounded shadow-sm" style="max-height: 200px;" id="current-cover-preview">
                                {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                                         style="height: 200px; width: 133px; margin: 0 auto;" id="current-cover-preview">
                                        <i class="bi bi-book text-muted" style="font-size: 3rem;"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- New Cover Preview -->
                        <div class="text-center mb-3">
                            <h6 class="text-muted mb-2">New Cover Preview</h6>
                            <div class="cover-preview-container">
                                <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                                     style="height: 200px; width: 133px; margin: 0 auto;" id="new-cover-preview">
                                    <i class="bi bi-eye text-muted" style="font-size: 3rem;"></i>
                                    <span class="text-muted ms-2">Preview</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="cover-edit-form" method="post" action="{{ url_for('main.edit_book', uid=book.uid) }}" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="update_cover"/>
                    
                    <!-- Cover URL Input -->
                    <div class="mb-3">
                        <label for="cover_url" class="form-label fw-medium">
                            <i class="bi bi-link me-1"></i>Cover Image URL
                        </label>
                        <div class="input-group">
                            <input type="url" class="form-control" id="cover_url" name="cover_url" 
                                   value="{{ book.cover_url or '' }}" placeholder="https://example.com/cover.jpg">
                            <button type="button" class="btn btn-outline-secondary" id="preview-url-btn">
                                <i class="bi bi-eye me-1"></i>Preview
                            </button>
                        </div>
                    </div>
                    
                    <!-- OR Divider -->
                    <div class="text-center my-3">
                        <span class="badge bg-secondary">OR</span>
                    </div>
                    
                    <!-- File Upload -->
                    <div class="mb-3">
                        <label for="cover_file" class="form-label fw-medium">
                            <i class="bi bi-upload me-1"></i>Upload from Device
                        </label>
                        <input type="file" class="form-control" id="cover_file" name="cover_file" 
                               accept="image/*">
                        <div class="form-text">Supported formats: JPG, PNG, GIF, WebP (max 5MB)</div>
                    </div>
                    
                    <!-- OR Divider -->
                    <div class="text-center my-3">
                        <span class="badge bg-secondary">OR</span>
                    </div>
                    
                    <!-- API Fetch -->
                    <div class="mb-3">
                        <label class="form-label fw-medium">
                            <i class="bi bi-cloud-download me-1"></i>Fetch from API
                        </label>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-info" id="fetch-cover-btn">
                                <i class="bi bi-search me-1"></i>Search for Cover by ISBN
                            </button>
                            {% if book.title and book.authors %}
                            <button type="button" class="btn btn-outline-info" id="fetch-cover-title-btn">
                                <i class="bi bi-search me-1"></i>Search by Title & Author
                            </button>
                            {% endif %}
                        </div>
                        <div class="form-text">
                            This will search for a cover image using the book's ISBN or title/author information
                        </div>
                    </div>
                    
                    <!-- Remove Cover Option -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="remove_cover" name="remove_cover">
                            <label class="form-check-label text-danger" for="remove_cover">
                                <i class="bi bi-trash me-1"></i>Remove current cover image
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="submit" form="cover-edit-form" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>Update Cover
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ownershipSelect = document.getElementById('ownership_status');
    const mediaTypeSelect = document.getElementById('media_type');
    const locationSection = document.getElementById('location-section');
    const borrowedSection = document.getElementById('borrowed-section');
    const loanedSection = document.getElementById('loaned-section');
    const locationSelect = document.getElementById('location_id');
    
    // Load user locations
    function loadLocations() {
        console.log('🏠 [LOCATIONS] Loading user locations...');
        fetch('/locations/api/user_locations')
            .then(response => response.json())
            .then(locations => {
                console.log('🏠 [LOCATIONS] Received locations:', locations);
                locationSelect.innerHTML = '<option value="">Select location...</option>';
                
                // Get book's current locations from the template
                const bookLocations = {{ book.locations|tojson if book.locations else '[]' }};
                const currentLocationId = bookLocations.length > 0 ? bookLocations[0] : null;
                console.log('🏠 [LOCATIONS] Book current locations:', bookLocations);
                console.log('🏠 [LOCATIONS] Using location ID:', currentLocationId);
                
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.name;
                    if (location.is_default) {
                        option.textContent += ' (Default)';
                    }
                    // Select the location if it matches the book's current location
                    if (location.id === currentLocationId) {
                        option.selected = true;
                        console.log('🏠 [LOCATIONS] ✅ Selected current location:', location.name, 'ID:', location.id);
                    }
                    locationSelect.appendChild(option);
                });
                console.log('🏠 [LOCATIONS] Location dropdown populated');
            })
            .catch(error => {
                console.error('❌ [LOCATIONS] Error loading locations:', error);
                locationSelect.innerHTML = '<option value="">Error loading locations</option>';
            });
    }
    
    function updateVisibility() {
        const ownership = ownershipSelect.value;
        const mediaType = mediaTypeSelect.value;
        
        // Show/hide location section based on media type
        locationSection.style.display = mediaType === 'physical' ? 'block' : 'none';
        
        // Show/hide borrowing/loaning sections with smooth transitions
        borrowedSection.style.display = ownership === 'borrowed' ? 'block' : 'none';
        loanedSection.style.display = ownership === 'loaned' ? 'block' : 'none';
    }
    
    // Event listeners
    ownershipSelect.addEventListener('change', updateVisibility);
    mediaTypeSelect.addEventListener('change', updateVisibility);
    
    // Initial setup
    loadLocations();
    updateVisibility();
    
    // Auto-save functionality (optional enhancement)
    const form = document.getElementById('status-form');
    let saveTimeout;
    
    function autoSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            // Could implement auto-save here
            console.log('Auto-save triggered');
        }, 2000);
    }
    
    // Add auto-save to form inputs if desired
    // form.querySelectorAll('select, input').forEach(input => {
    //     input.addEventListener('change', autoSave);
    // });
    
    // Cover editing functionality
    initializeCoverEditing();
});

function initializeCoverEditing() {
    const coverUrlInput = document.getElementById('cover_url');
    const previewUrlBtn = document.getElementById('preview-url-btn');
    const coverFileInput = document.getElementById('cover_file');
    const fetchCoverBtn = document.getElementById('fetch-cover-btn');
    const fetchCoverTitleBtn = document.getElementById('fetch-cover-title-btn');
    const newCoverPreview = document.getElementById('new-cover-preview');
    const removeCoverCheck = document.getElementById('remove_cover');
    
    // Preview URL functionality
    if (previewUrlBtn && coverUrlInput) {
        previewUrlBtn.addEventListener('click', function() {
            const url = coverUrlInput.value.trim();
            if (url) {
                previewCoverImage(url);
            } else {
                alert('Please enter a URL first.');
            }
        });
        
        // Auto-preview when URL changes
        coverUrlInput.addEventListener('blur', function() {
            const url = this.value.trim();
            if (url) {
                previewCoverImage(url);
            }
        });
    }
    
    // File upload preview
    if (coverFileInput) {
        coverFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Clear URL input when file is selected
                if (coverUrlInput) coverUrlInput.value = '';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewCoverImage(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Fetch cover by ISBN
    if (fetchCoverBtn) {
        fetchCoverBtn.addEventListener('click', function() {
            const isbn = '{{ book.isbn13 or book.isbn10 or book.isbn or "" }}';
            if (isbn) {
                fetchCoverFromAPI(isbn, 'isbn');
            } else {
                alert('No ISBN available for this book.');
            }
        });
    }
    
    // Fetch cover by title and author
    if (fetchCoverTitleBtn) {
        fetchCoverTitleBtn.addEventListener('click', function() {
            const title = '{{ book.title|e }}';
            const author = '{{ (book.authors[0].name if book.authors else "")|e }}';
            if (title && author) {
                fetchCoverFromAPI(`${title} ${author}`, 'title');
            } else {
                alert('Missing title or author information.');
            }
        });
    }
    
    // Remove cover checkbox
    if (removeCoverCheck) {
        removeCoverCheck.addEventListener('change', function() {
            if (this.checked) {
                // Clear other inputs and show placeholder
                if (coverUrlInput) coverUrlInput.value = '';
                if (coverFileInput) coverFileInput.value = '';
                showPlaceholderPreview();
            }
        });
    }
}

function previewCoverImage(src) {
    const preview = document.getElementById('new-cover-preview');
    if (preview && src) {
        preview.innerHTML = `<img src="${src}" alt="Cover Preview" class="img-fluid rounded shadow-sm" style="max-height: 200px;">`;
        
        // Uncheck remove cover if checked
        const removeCoverCheck = document.getElementById('remove_cover');
        if (removeCoverCheck) removeCoverCheck.checked = false;
    }
}

function showPlaceholderPreview() {
    const preview = document.getElementById('new-cover-preview');
    if (preview) {
        preview.innerHTML = `
            <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                 style="height: 200px; width: 133px; margin: 0 auto;">
                <i class="bi bi-book text-muted" style="font-size: 3rem;"></i>
            </div>
        `;
    }
}

function fetchCoverFromAPI(query, type) {
    const fetchBtn = type === 'isbn' ? document.getElementById('fetch-cover-btn') : document.getElementById('fetch-cover-title-btn');
    const originalText = fetchBtn.innerHTML;
    
    // Show loading state
    fetchBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Searching...';
    fetchBtn.disabled = true;
    
    const endpoint = type === 'isbn' ? 
        `/api/search/book/${query}` :
        `/api/search/cover?q=${encodeURIComponent(query)}`;
    
    fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            if (data.cover) {
                // Update URL input and preview
                const coverUrlInput = document.getElementById('cover_url');
                if (coverUrlInput) {
                    coverUrlInput.value = data.cover;
                }
                previewCoverImage(data.cover);
                
                // Clear file input
                const coverFileInput = document.getElementById('cover_file');
                if (coverFileInput) coverFileInput.value = '';
            } else {
                alert('No cover image found for this book.');
            }
        })
        .catch(error => {
            console.error('Error fetching cover:', error);
            alert('Failed to fetch cover image. Please try again.');
        })
        .finally(() => {
            // Restore button state
            fetchBtn.innerHTML = originalText;
            fetchBtn.disabled = false;
        });
});
</script>

<style>
/* Dark mode enhancements for View Book */
[data-theme="dark"] .text-muted {
    color: #b0b0b0 !important;
}

[data-theme="dark"] small.text-muted {
    color: #c0c0c0 !important;
}

[data-theme="dark"] .form-text {
    color: #c0c0c0 !important;
}

[data-theme="dark"] .form-text a {
    color: #6ea8fe !important;
}

[data-theme="dark"] .card {
    background-color: rgba(40, 40, 40, 0.8) !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .card-header {
    background-color: rgba(60, 60, 60, 0.8) !important;
    border-bottom-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .card-body {
    color: #e0e0e0 !important;
}

[data-theme="dark"] .bg-light {
    background-color: rgba(50, 50, 50, 0.8) !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] #borrowed-section,
[data-theme="dark"] #loaned-section {
    background-color: rgba(50, 50, 50, 0.8) !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .form-label {
    color: #e0e0e0 !important;
}

[data-theme="dark"] .fw-medium {
    color: #e0e0e0 !important;
}

[data-theme="dark"] .accordion-item {
    background-color: rgba(40, 40, 40, 0.8) !important;
    border-color: #404040 !important;
}

[data-theme="dark"] .accordion-body {
    background-color: rgba(40, 40, 40, 0.8) !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .badge.bg-light {
    background-color: rgba(60, 60, 60, 0.8) !important;
    color: #e0e0e0 !important;
    border-color: #404040 !important;
}

[data-theme="dark"] .breadcrumb-item a {
    color: #6ea8fe !important;
}

[data-theme="dark"] .breadcrumb-item.active {
    color: #b0b0b0 !important;
}

[data-theme="dark"] .h6.text-muted {
    color: #b0b0b0 !important;
}

[data-theme="dark"] .text-center.text-muted {
    color: #b0b0b0 !important;
}

[data-theme="dark"] .text-center.text-muted p {
    color: #b0b0b0 !important;
}

[data-theme="dark"] .text-center.text-muted .small {
    color: #c0c0c0 !important;
}

[data-theme="dark"] .text-primary {
    color: #6ea8fe !important;
}

/* Additional form styling for dark mode */
[data-theme="dark"] .form-control,
[data-theme="dark"] .form-select {
    background-color: #2d2d2d !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .form-control:focus,
[data-theme="dark"] .form-select:focus {
    background-color: #2d2d2d !important;
    border-color: #86b7fe !important;
    color: #e0e0e0 !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

/* Action Icon Buttons Styling */
.action-icon-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.action-icon-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.action-icon-btn.btn-outline-primary:hover {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
}

.action-icon-btn.btn-outline-danger:hover {
    background-color: var(--bs-danger);
    border-color: var(--bs-danger);
    color: white;
}

/* Dark mode for action icons */
[data-theme="dark"] .action-icon-btn {
    background-color: rgba(40, 40, 40, 0.9);
    border-color: #555;
    color: #e0e0e0;
}

[data-theme="dark"] .action-icon-btn.btn-outline-primary {
    border-color: var(--bs-primary);
    color: var(--bs-primary);
}

[data-theme="dark"] .action-icon-btn.btn-outline-danger {
    border-color: var(--bs-danger);
    color: var(--bs-danger);
}

[data-theme="dark"] .action-icon-btn:hover {
    background-color: rgba(60, 60, 60, 0.9);
}

/* Cover Edit Button Styling */
.cover-edit-btn {
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    z-index: 10;
}

.cover-edit-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    background-color: var(--bs-secondary);
    border-color: var(--bs-secondary);
    color: white;
}

/* Dark mode for cover edit button */
[data-theme="dark"] .cover-edit-btn {
    background-color: rgba(40, 40, 40, 0.9);
    border-color: #555;
    color: #e0e0e0;
}

[data-theme="dark"] .cover-edit-btn:hover {
    background-color: var(--bs-secondary);
    border-color: var(--bs-secondary);
    color: white;
}

/* Cover preview styling */
.cover-preview-container {
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Modal enhancements */
[data-theme="dark"] .modal-content {
    background-color: #2d2d2d;
    border-color: #404040;
    color: #e0e0e0;
}

[data-theme="dark"] .modal-header {
    border-bottom-color: #404040;
}

[data-theme="dark"] .modal-footer {
    border-top-color: #404040;
}

[data-theme="dark"] .form-check-label {
    color: #e0e0e0;
}

[data-theme="dark"] .form-check-label.text-danger {
    color: #ff6b6b !important;
}

.card {
    border: none;
    transition: box-shadow 0.15s ease-in-out;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
}

.accordion-item {
    border: 1px solid rgba(0,0,0,.125);
    border-radius: 0.375rem;
}

.accordion-button {
    font-weight: 500;
    border-radius: 0.375rem;
}

.accordion-button:not(.collapsed) {
    color: white;
    background-color: var(--bs-primary);
    box-shadow: none;
}

.accordion-button.bg-primary:not(.collapsed) {
    background-color: var(--bs-primary) !important;
}

.accordion-button.bg-success:not(.collapsed) {
    background-color: var(--bs-success) !important;
}

.accordion-button.bg-info:not(.collapsed) {
    background-color: var(--bs-info) !important;
}

.accordion-button.bg-warning:not(.collapsed) {
    background-color: var(--bs-warning) !important;
}

.accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.accordion-body {
    padding: 1.25rem;
}

.form-label {
    color: #495057;
    font-size: 0.9rem;
}

.badge {
    font-size: 0.75rem;
}

.btn {
    font-size: 0.9rem;
}

#borrowed-section, #loaned-section {
    border: 1px solid #dee2e6;
    background-color: #f8f9fa;
}

.breadcrumb-item a {
    text-decoration: none;
}

/* Smooth transitions for accordion */
.accordion-collapse {
    transition: height 0.35s ease;
}

/* Better spacing between accordion items */
.accordion-item:not(:last-child) {
    margin-bottom: 0.5rem;
}

/* Genre badge hover effects */
.badge.bg-light:hover {
    background-color: #e2e6ea !important;
    transform: translateY(-1px);
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.badge.bg-secondary:hover {
    background-color: #5a6268 !important;
    transform: translateY(-1px);
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Dark mode support */
[data-theme="dark"] .badge.bg-light:hover {
    background-color: #495057 !important;
    color: white !important;
}
</style>

<!-- Debug Panel (Admin Only) -->
{% include 'components/debug_panel.html' %}

{% endblock %}
