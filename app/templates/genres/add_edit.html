{% extends "base.html" %}

{% block title %}{% if category %}Edit {{ category.name }}{% else %}Add Category{% endif %} - Genres - {{ site_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <!-- Page Header -->
            <div class="d-flex align-items-center mb-4">
                <a href="{{ url_for('genres.index') }}" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <h1 class="h2 mb-0">
                        {% if category %}
                            <i class="bi bi-pencil me-2"></i>Edit Category
                        {% else %}
                            <i class="bi bi-plus-circle me-2"></i>Add Category
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if category %}
                            Update the details for "{{ category.name }}"
                        {% else %}
                            Create a new category for organizing your books
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Form Card -->
            <div class="card">
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <!-- Basic Information Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Basic Information
                            </h5>
                            
                            <!-- Name Field -->
                            <div class="mb-3">
                                {{ form.name.label(class="form-label required") }}
                                {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else ""), placeholder="e.g., Science Fiction, Mystery, Non-Fiction") }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    The primary name for this category. This will be used in searches and displays.
                                </div>
                            </div>

                            <!-- Appearance Section -->
                            <div class="mb-4">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-palette"></i> Appearance
                                </h6>
                                
                                <div class="row">
                                    <!-- Icon Field -->
                                    <div class="col-md-6 mb-3">
                                        {{ form.icon.label(class="form-label") }}
                                        <div class="input-group">
                                            {{ form.icon(class="form-control", placeholder="üìö") }}
                                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#iconPicker">
                                                <i class="bi bi-emoji-smile"></i>
                                            </button>
                                        </div>
                                        {% if form.icon.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.icon.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">
                                            An emoji or icon to represent this category.
                                        </div>
                                        
                                        <!-- Icon Preview -->
                                        <div id="icon-preview" class="mt-2 {% if not form.icon.data %}d-none{% endif %}">
                                            <small class="text-muted">Preview:</small>
                                            <span id="icon-display" class="ms-2 fs-4">{{ form.icon.data or '' }}</span>
                                        </div>
                                    </div>

                                    <!-- Color Field -->
                                    <div class="col-md-6 mb-3">
                                        {{ form.color.label(class="form-label") }}
                                        <div class="input-group">
                                            {{ form.color(class="form-control form-control-color", style="width: 60px;") }}
                                            <input type="text" class="form-control" id="color-hex" value="{{ form.color.data or '#6c757d' }}" 
                                                   placeholder="#000000" pattern="^#[0-9A-Fa-f]{6}$">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#colorPicker">
                                                <i class="bi bi-palette"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="randomColor()">
                                                <i class="bi bi-shuffle"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="clearColor()">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                        {% if form.color.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.color.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">
                                            A color to help visually distinguish this category. Use the palette button for more options.
                                        </div>
                                    </div>
                                </div>

                                <!-- Appearance Preview -->
                                <div class="alert alert-light border">
                                    <strong>Preview:</strong>
                                    <div class="mt-2">
                                        <div class="d-inline-flex align-items-center border rounded p-2" id="category-preview">
                                            <span id="preview-icon">{{ form.icon.data or 'üè∑Ô∏è' }}</span>
                                            <span class="ms-2 fw-bold" id="preview-name">{{ form.name.data or 'Category Name' }}</span>
                                            <div class="ms-2 color-indicator" id="preview-color" 
                                                 style="background-color: {{ form.color.data or '#6c757d' }};"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Description Field -->
                            <div class="mb-3">
                                {{ form.description.label(class="form-label") }}
                                {{ form.description(class="form-control", rows="3", placeholder="Optional description to help users understand what books belong in this category...") }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    A brief description of what types of books belong in this category.
                                </div>
                            </div>
                        </div>

                        <!-- Hierarchy Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-diagram-3"></i> Category Hierarchy
                            </h5>
                            
                            <!-- Parent Category Field -->
                            <div class="mb-3">
                                {{ form.parent_id.label(class="form-label") }}
                                {{ form.parent_id(class="form-select") }}
                                {% if form.parent_id.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.parent_id.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Select a parent category to create a hierarchy. Leave empty for a root-level category.
                                </div>
                            </div>

                            <!-- Current Hierarchy Display -->
                            {% if category and category.level > 0 %}
                            <div class="alert alert-info">
                                <strong>Current Path:</strong>
                                <nav aria-label="Category path">
                                    <ol class="breadcrumb mb-0">
                                        {% for ancestor in category.get_ancestors() %}
                                        <li class="breadcrumb-item">{{ ancestor.name }}</li>
                                        {% endfor %}
                                        <li class="breadcrumb-item active">{{ category.name }}</li>
                                    </ol>
                                </nav>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Aliases Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-tags"></i> Aliases & Alternative Names
                            </h5>
                            
                            <div class="mb-3">
                                {{ form.aliases.label(class="form-label") }}
                                {{ form.aliases(class="form-control", placeholder="e.g., Sci-Fi, SF, Speculative Fiction (one per line)") }}
                                {% if form.aliases.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.aliases.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Alternative names that this category might be known by. Enter one alias per line. These help with imports and searches.
                                </div>
                            </div>

                            <!-- Alias Preview -->
                            <div id="alias-preview" class="d-none">
                                <small class="text-muted">Preview:</small>
                                <div id="alias-tags" class="mt-1"></div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <a href="{% if category %}{{ url_for('genres.category_details', category_id=category.id) }}{% else %}{{ url_for('genres.index') }}{% endif %}" 
                                   class="btn btn-secondary">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                            </div>
                            <div>
                                {% if category %}
                                <a href="{{ url_for('genres.category_details', category_id=category.id) }}" class="btn btn-outline-primary me-2">
                                    <i class="bi bi-eye"></i> View Details
                                </a>
                                {% endif %}
                                <button type="submit" class="btn btn-success">
                                    {% if category %}
                                        <i class="bi bi-check-circle"></i> Update Category
                                    {% else %}
                                        <i class="bi bi-plus-circle"></i> Create Category
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tips Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-lightbulb"></i> Tips for Creating Categories
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li><strong>Use clear names:</strong> Choose names that are easily understood and commonly used.</li>
                        <li><strong>Think hierarchically:</strong> Consider if this category should be a subcategory of an existing one.</li>
                        <li><strong>Add aliases:</strong> Include common alternative names to help with imports and searches.</li>
                        <li><strong>Be consistent:</strong> Follow your existing naming conventions and organization patterns.</li>
                        <li><strong>Consider the future:</strong> Think about how books will be categorized as your library grows.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Icon Picker Modal -->
<div class="modal fade" id="iconPicker" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Choose an Icon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2" id="emoji-grid">
                    <!-- Common book and genre related emojis -->
                    {% set book_emojis = ['üìö', 'üìñ', 'üìù', 'üìú', 'üìã', 'üè∑Ô∏è', 'üîñ', 'üìë', 'üìÑ', 'üì∞', 'üóûÔ∏è', 'üìì', 'üìî', 'üìï', 'üìó', 'üìò', 'üìô', 'üìí', 'üíº', 'üé≠', 'üî¨', 'üß™', '‚öóÔ∏è', 'üî≠', 'üåü', '‚≠ê', 'üí´', 'üåà', 'üé®', 'üñºÔ∏è', 'üé™', 'üé¨', 'üé≠', 'üé™', 'üé®', 'üèõÔ∏è', 'üè∞', 'üóø', 'üåç', 'üåé', 'üåè', 'üó∫Ô∏è', 'üß≠', '‚öîÔ∏è', 'üõ°Ô∏è', 'üëë', 'üíé', 'üîÆ', 'üßô‚Äç‚ôÇÔ∏è', 'üßô‚Äç‚ôÄÔ∏è', 'üßö‚Äç‚ôÇÔ∏è', 'üßö‚Äç‚ôÄÔ∏è', 'ü¶Ñ', 'üêâ', 'üßõ‚Äç‚ôÇÔ∏è', 'üßõ‚Äç‚ôÄÔ∏è', 'üßü‚Äç‚ôÇÔ∏è', 'üßü‚Äç‚ôÄÔ∏è', 'üëª', 'üíÄ', 'üéÉ', 'üï∑Ô∏è', 'ü¶á', 'üåô', '‚òÄÔ∏è', '‚ö°', 'üî•', '‚ùÑÔ∏è', 'üíß', 'üåä', 'üåã', 'üèîÔ∏è', 'üèïÔ∏è', 'üèúÔ∏è', 'üèùÔ∏è', 'üå¥', 'üå≤', 'üåø', 'üçÄ', 'üå∫', 'üåª', 'üå∑', 'üåπ', 'üíê', 'üå∏', 'üåº', 'üåµ', 'üçÑ', 'üéØ', 'üé≤', '‚ô†Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è', 'üÉè', 'üé∞', 'üîë', 'üóùÔ∏è', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'üîç', 'üîé', 'üî¨', 'üß¨', '‚öôÔ∏è', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', 'üî´', 'üí£', 'üß®', 'üî™', '‚öîÔ∏è', 'üõ°Ô∏è', 'üèπ', 'üè∫', '‚ö±Ô∏è', 'üóø', 'üé∫', 'üé∑', 'üé∏', 'üéª', 'üéπ', 'ü•Å', 'üéº', 'üéµ', 'üé∂', 'üé§', 'üéß', 'üìª', 'üì∫', 'üì±', 'üíª', 'üñ•Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üñ®Ô∏è', 'üì∑', 'üìπ', 'üé•', 'üìΩÔ∏è', 'üîã', 'üí°', 'üî¶', 'üïØÔ∏è', 'üßØ', 'üõ¢Ô∏è', 'üíä', 'üß™', 'üß¨', 'üî¨', 'üß≤', 'üíâ', 'ü©∏', 'üß∏', 'üéÄ', 'üéÅ', 'üéà', 'üéâ', 'üéä', 'üéÇ', 'üç∞', 'üßÅ', 'üç™', 'üç´', 'üç¨', 'üç≠', 'üçØ', 'üçº'] %}
                    {% for emoji in book_emojis %}
                    <div class="col-2 col-md-1">
                        <button type="button" class="btn btn-outline-light border p-2 w-100 emoji-btn" 
                                data-emoji="{{ emoji }}" onclick="selectEmoji('{{ emoji }}')">
                            {{ emoji }}
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-danger" onclick="clearIcon()">
                    <i class="bi bi-x"></i> Clear Icon
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Color Picker Modal -->
<div class="modal fade" id="colorPicker" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Choose a Color</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6>Preset Colors</h6>
                    <div class="row g-2" id="preset-colors">
                        <!-- Preset colors will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Color Wheel</h6>
                        <div class="color-wheel-container">
                            <input type="color" id="color-wheel" class="form-control form-control-color w-100" style="height: 200px;">
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>RGB / Hex Input</h6>
                        <div class="mb-3">
                            <label for="color-hex-input" class="form-label">Hex Color</label>
                            <input type="text" class="form-control" id="color-hex-input" placeholder="#FF5733" pattern="^#[0-9A-Fa-f]{6}$">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">RGB Values</label>
                            <div class="row g-2">
                                <div class="col-4">
                                    <input type="number" class="form-control" id="rgb-r" placeholder="Red" min="0" max="255">
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control" id="rgb-g" placeholder="Green" min="0" max="255">
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control" id="rgb-b" placeholder="Blue" min="0" max="255">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Preview</label>
                            <div class="color-preview" id="color-preview" style="height: 60px; border: 1px solid #ccc; border-radius: 4px; background-color: #6c757d;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-warning" onclick="randomColor()">
                    <i class="bi bi-shuffle"></i> Random Color
                </button>
                <button type="button" class="btn btn-primary" onclick="applySelectedColor()">
                    <i class="bi bi-check"></i> Apply Color
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.required::after {
    content: " *";
    color: #dc3545;
}

.color-indicator {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: inline-block;
    border: 1px solid #dee2e6;
}

.emoji-btn {
    font-size: 1.2em;
    transition: transform 0.1s;
}

.emoji-btn:hover {
    transform: scale(1.1);
}

#category-preview {
    transition: all 0.3s ease;
}

.form-control-color {
    height: 38px;
}

.color-preset-btn {
    border: 2px solid #dee2e6;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.color-preset-btn:hover {
    border-color: #007bff;
    transform: scale(1.1);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.color-wheel-container {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.5rem;
}

.category-tag-display,
.category-tag {
    transition: all 0.2s ease;
}

.category-tag-display:hover,
.category-tag:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

<script>
// Real-time preview updates
document.addEventListener('DOMContentLoaded', function() {
    const nameField = document.getElementById('{{ form.name.id }}');
    const iconField = document.getElementById('{{ form.icon.id }}');
    const colorField = document.getElementById('{{ form.color.id }}');
    const colorHex = document.getElementById('color-hex');
    const aliasField = document.getElementById('{{ form.aliases.id }}');
    
    // Update preview elements
    const previewName = document.getElementById('preview-name');
    const previewIcon = document.getElementById('preview-icon');
    const previewColor = document.getElementById('preview-color');
    const iconPreview = document.getElementById('icon-preview');
    const iconDisplay = document.getElementById('icon-display');
    const aliasPreview = document.getElementById('alias-preview');
    const aliasTags = document.getElementById('alias-tags');
    
    // Name field updates
    nameField.addEventListener('input', function() {
        previewName.textContent = this.value || 'Category Name';
    });
    
    // Icon field updates
    iconField.addEventListener('input', function() {
        const icon = this.value || 'üè∑Ô∏è';
        previewIcon.textContent = icon;
        iconDisplay.textContent = icon;
        
        if (this.value) {
            iconPreview.classList.remove('d-none');
        } else {
            iconPreview.classList.add('d-none');
        }
    });
    
    // Color field updates
    colorField.addEventListener('input', function() {
        previewColor.style.backgroundColor = this.value;
        colorHex.value = this.value;
    });
    
    // Make color hex input editable and sync with color picker
    colorHex.addEventListener('input', function() {
        const hexValue = this.value;
        if (/^#[0-9A-Fa-f]{6}$/.test(hexValue)) {
            colorField.value = hexValue;
            previewColor.style.backgroundColor = hexValue;
        }
    });
    
    // Alias field updates
    aliasField.addEventListener('input', function() {
        const aliases = this.value.split('\n').filter(alias => alias.trim());
        
        if (aliases.length > 0) {
            aliasTags.innerHTML = aliases.map(alias => 
                `<span class="badge bg-secondary me-1">${alias.trim()}</span>`
            ).join('');
            aliasPreview.classList.remove('d-none');
        } else {
            aliasPreview.classList.add('d-none');
        }
    });
    
    // Initialize color hex display
    colorHex.value = colorField.value;
    
    // Initialize alias preview
    if (aliasField.value) {
        aliasField.dispatchEvent(new Event('input'));
    }
});

// Icon picker functions
function selectEmoji(emoji) {
    const iconField = document.getElementById('{{ form.icon.id }}');
    iconField.value = emoji;
    iconField.dispatchEvent(new Event('input'));
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('iconPicker'));
    modal.hide();
}

function clearIcon() {
    const iconField = document.getElementById('{{ form.icon.id }}');
    iconField.value = '';
    iconField.dispatchEvent(new Event('input'));
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('iconPicker'));
    modal.hide();
}

// Enhanced Color Picker Functions
function initializeColorPicker() {
    // Preset colors (same as server-side random colors)
    const presetColors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
        '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
        '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#F9E79F',
        '#D2B4DE', '#AED6F1', '#A9DFBF', '#F5B7B1', '#D5DBDB',
        '#FF7675', '#74B9FF', '#00B894', '#FDCB6E', '#E17055',
        '#6C5CE7', '#FD79A8', '#00CEC9', '#55A3FF', '#A29BFE'
    ];
    
    // Populate preset colors
    const presetContainer = document.getElementById('preset-colors');
    presetColors.forEach(color => {
        const colorBtn = document.createElement('div');
        colorBtn.className = 'col-2 col-sm-1';
        colorBtn.innerHTML = `
            <button type="button" class="btn p-2 w-100 color-preset-btn" 
                    style="background-color: ${color}; height: 40px;" 
                    onclick="selectPresetColor('${color}')" 
                    title="${color}"></button>
        `;
        presetContainer.appendChild(colorBtn);
    });
    
    // Initialize color wheel
    const colorWheel = document.getElementById('color-wheel');
    const colorHexInput = document.getElementById('color-hex-input');
    const rgbR = document.getElementById('rgb-r');
    const rgbG = document.getElementById('rgb-g');
    const rgbB = document.getElementById('rgb-b');
    const colorPreview = document.getElementById('color-preview');
    
    // Sync color wheel with inputs
    colorWheel.addEventListener('input', function() {
        const color = this.value;
        updateColorInputs(color);
    });
    
    // Sync hex input
    colorHexInput.addEventListener('input', function() {
        const hex = this.value;
        if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
            colorWheel.value = hex;
            updateColorInputs(hex);
        }
    });
    
    // Sync RGB inputs
    [rgbR, rgbG, rgbB].forEach(input => {
        input.addEventListener('input', function() {
            const r = parseInt(rgbR.value) || 0;
            const g = parseInt(rgbG.value) || 0;
            const b = parseInt(rgbB.value) || 0;
            const hex = rgbToHex(r, g, b);
            colorWheel.value = hex;
            colorHexInput.value = hex;
            updateColorInputs(hex);
        });
    });
    
    // Initialize with current color
    const currentColor = document.getElementById('{{ form.color.id }}').value || '#6c757d';
    updateColorInputs(currentColor);
}

function updateColorInputs(color) {
    const colorPreview = document.getElementById('color-preview');
    const colorHexInput = document.getElementById('color-hex-input');
    const rgbR = document.getElementById('rgb-r');
    const rgbG = document.getElementById('rgb-g');
    const rgbB = document.getElementById('rgb-b');
    
    colorPreview.style.backgroundColor = color;
    colorHexInput.value = color;
    
    // Convert to RGB
    const rgb = hexToRgb(color);
    if (rgb) {
        rgbR.value = rgb.r;
        rgbG.value = rgb.g;
        rgbB.value = rgb.b;
    }
}

function selectPresetColor(color) {
    document.getElementById('color-wheel').value = color;
    updateColorInputs(color);
}

function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function rgbToHex(r, g, b) {
    r = Math.max(0, Math.min(255, r));
    g = Math.max(0, Math.min(255, g));
    b = Math.max(0, Math.min(255, b));
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

function randomColor() {
    const colors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
        '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
        '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#F9E79F',
        '#D2B4DE', '#AED6F1', '#A9DFBF', '#F5B7B1', '#D5DBDB',
        '#FF7675', '#74B9FF', '#00B894', '#FDCB6E', '#E17055',
        '#6C5CE7', '#FD79A8', '#00CEC9', '#55A3FF', '#A29BFE'
    ];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    // Update main form
    const colorField = document.getElementById('{{ form.color.id }}');
    const colorHex = document.getElementById('color-hex');
    const previewColor = document.getElementById('preview-color');
    
    colorField.value = randomColor;
    colorHex.value = randomColor;
    previewColor.style.backgroundColor = randomColor;
    
    // Update modal if open
    const colorWheel = document.getElementById('color-wheel');
    if (colorWheel) {
        updateColorInputs(randomColor);
        colorWheel.value = randomColor;
    }
}

function applySelectedColor() {
    const selectedColor = document.getElementById('color-wheel').value;
    const colorField = document.getElementById('{{ form.color.id }}');
    const colorHex = document.getElementById('color-hex');
    const previewColor = document.getElementById('preview-color');
    
    colorField.value = selectedColor;
    colorHex.value = selectedColor;
    previewColor.style.backgroundColor = selectedColor;
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('colorPicker'));
    modal.hide();
}

// Initialize color picker when modal is shown
document.getElementById('colorPicker').addEventListener('shown.bs.modal', function() {
    if (!this.hasAttribute('data-initialized')) {
        initializeColorPicker();
        this.setAttribute('data-initialized', 'true');
    }
});

function clearColor() {
    const colorField = document.getElementById('{{ form.color.id }}');
    const colorHex = document.getElementById('color-hex');
    
    colorField.value = '#6c757d';
    colorHex.value = '#6c757d';
    colorField.dispatchEvent(new Event('input'));
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const nameField = document.getElementById('{{ form.name.id }}');
    
    if (!nameField.value.trim()) {
        e.preventDefault();
        nameField.focus();
        nameField.classList.add('is-invalid');
    }
});
</script>
{% endblock %}
